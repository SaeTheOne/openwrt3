# .github/workflows/pack-image.yml
name: ðŸ“¦ Pack OpenWrt/ImmortalWrt Image

on:
  workflow_call:
    inputs:
      rootfs_url:
        description: 'URL to the rootfs tarball (e.g., from GitHub Releases)'
        required: true
        type: string
      whoami_content:
        description: 'Content of the whoami file for openwrt_packit'
        required: true
        type: string
    secrets:
      GITHUB_TOKEN:
        required: false  # only needed if downloading private repos

jobs:
  pack:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout openwrt_packit
        uses: actions/checkout@v4
        with:
          repository: unifreq/openwrt_packit
          path: .

      - name: Download and smart-rename rootfs
        run: |
          URL="${{ inputs.rootfs_url }}"
          echo "ðŸ“¥ Downloading rootfs from: $URL"
          wget -O downloaded-rootfs.tar.gz "$URL"

          ORIGINAL_NAME=$(basename "$URL")
          echo "Original filename: $ORIGINAL_NAME"

          # Case-insensitive check for openwrt prefix
          if [[ "${ORIGINAL_NAME,,}" == openwrt-* ]]; then
            FINAL_NAME="$ORIGINAL_NAME"
            echo "âœ… Already OpenWrt-style, keeping name."
          else
            FINAL_NAME="openwrt${ORIGINAL_NAME#*-}"
            echo "ðŸ”„ Renamed to: $FINAL_NAME"
          fi

          mv downloaded-rootfs.tar.gz "$FINAL_NAME"
          echo "ROOTFS_FILE=$FINAL_NAME" >> $GITHUB_ENV

      - name: Write whoami file
        run: |
          echo '${{ inputs.whoami_content }}' > whoami
          cat whoami

      - name: Run packing script
        run: |
          ROOTFS_FILE="${{ env.ROOTFS_FILE }}"
          echo "ðŸ“¦ Packing image using: $ROOTFS_FILE"
          sudo cp "$ROOTFS_FILE" .
          sudo ./mk_s905d_n1.sh _test

      - name: Upload packed image(s)
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-packed-image
          path: output/*.img
          if-no-files-found: error
