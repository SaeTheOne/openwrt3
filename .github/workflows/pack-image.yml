name: üì¶ Pack OpenWrt/ImmortalWrt Image

on:
  workflow_call:
    inputs:
      rootfs_url:
        description: 'ËøúÁ®ã rootfs ‰∏ãËΩΩ URLÔºàÂèØÈÄâÔºâ'
        required: false
        type: string
      rootfs_path:
        description: 'ÊûÑÂª∫ÁîüÊàêÁöÑ rootfs Ë∑ØÂæÑÔºàÁî®‰∫éÂêå‰ªìË∞ÉÁî®Êó∂ÁöÑÊèêÁ§∫Ôºå‰ªÖÁî®‰∫éÊó•ÂøóÔºâ'
        required: false
        type: string
      whoami_content:
        description: 'openwrt_packit ÁöÑ whoami Êñá‰ª∂ÂÜÖÂÆπÔºàÂèØÈÄâÔºâ'
        required: false
        type: string
      kernel_base_url:
        description: 'ÂÜÖÊ†∏ tarball Âü∫Á°Ä URLÔºàÈªòËÆ§‰∏∫ SaeTheOne/openwrt3 flippy_kernelÔºâ'
        required: false
        type: string
  workflow_dispatch:
    inputs:
      rootfs_url:
        description: 'ËøúÁ®ã rootfs ‰∏ãËΩΩ URLÔºàÂèØÈÄâÔºâ'
        required: false
        default: ''
      whoami_content:
        description: 'openwrt_packit ÁöÑ whoami Êñá‰ª∂ÂÜÖÂÆπÔºàÂèØÈÄâÔºâ'
        required: false
        default: ''
      kernel_base_url:
        description: 'ÂÜÖÊ†∏ tarball Âü∫Á°Ä URLÔºàÈªòËÆ§‰∏∫ SaeTheOne/openwrt3 flippy_kernelÔºâ'
        required: false
        default: 'https://raw.githubusercontent.com/SaeTheOne/openwrt3/main/flippy_kernel'

jobs:
  pack:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout openwrt_packit
        uses: actions/checkout@v4
        with:
          repository: unifreq/openwrt_packit
          path: .

      - name: Write whoami file
        run: |
          if [ -n "${{ inputs.whoami_content }}" ]; then
            CONTENT="${{ inputs.whoami_content }}"
            printf "%s\n" "$CONTENT" > whoami
          else
            # ‰ªéË∞ÉÁî®‰ªìÂ∫ìÈªòËÆ§ÂàÜÊîØÊãâÂèñ whoamiÔºàÂ¶ÇÂ§±Ë¥•Âàô‰øùÊåÅÁ©∫Ôºâ
            REPO="${GITHUB_REPOSITORY}"
            BRANCH="main"
            URL="https://raw.githubusercontent.com/${REPO}/${BRANCH}/flippy_kernel/whoami"
            echo "Â∞ùËØïËé∑Âèñ whoami: $URL"
            curl -fsSL "$URL" -o whoami || true
          fi

          echo "ÂΩìÂâç whoami ÂÜÖÂÆπ:"
          cat whoami || true

      - name: Prepare kernel files based on whoami
        run: |
          set -e
          KERNEL_VERSION=$(grep '^KERNEL_VERSION=' whoami | cut -d'=' -f2)
          if [ -z "$KERNEL_VERSION" ]; then
            echo "Êú™Âú® whoami ‰∏≠ÊâæÂà∞ KERNEL_VERSION"
            exit 1
          fi
          BASE_URL="${{ inputs.kernel_base_url }}"
          [ -z "$BASE_URL" ] && BASE_URL="https://raw.githubusercontent.com/SaeTheOne/openwrt3/main/flippy_kernel"
          echo "‰ΩøÁî®ÂÜÖÊ†∏ÁâàÊú¨: $KERNEL_VERSION"
          echo "ÂÜÖÊ†∏Êù•Ê∫ê: $BASE_URL"
          sudo mkdir -p /opt/kernel
          cd /tmp
          for f in \
            "boot-$KERNEL_VERSION.tar.gz" \
            "dtb-allwinner-$KERNEL_VERSION.tar.gz" \
            "dtb-amlogic-$KERNEL_VERSION.tar.gz" \
            "dtb-rockchip-$KERNEL_VERSION.tar.gz" \
            "header-$KERNEL_VERSION.tar.gz" \
            "modules-$KERNEL_VERSION.tar.gz"; do
            echo "‰∏ãËΩΩ: $BASE_URL/$f"
            curl -fsSL "$BASE_URL/$f" -o "$f"
            sudo cp "$f" /opt/kernel/
          done

      - name: Download rootfs from URL
        if: ${{ inputs.rootfs_url != '' }}
        run: |
          URL="${{ inputs.rootfs_url }}"
          echo "üì• ‰ªé URL ‰∏ãËΩΩ rootfs: $URL"
          curl -fsSL "$URL" -o openwrt-armvirt-64-default-rootfs.tar.gz
          echo "ROOTFS_FILE=openwrt-armvirt-64-default-rootfs.tar.gz" >> $GITHUB_ENV

      - name: Download rootfs artifact (fallback)
        if: ${{ inputs.rootfs_url == '' }}
        uses: actions/download-artifact@v4
        with:
          name: openwrt-rootfs-for-packing
          path: ./artifact_rootfs

      - name: Prepare rootfs from artifact
        if: ${{ inputs.rootfs_url == '' }}
        run: |
          set -e
          FILE=$(ls -1 ./artifact_rootfs/*.tar.gz | head -n1)
          if [ -z "$FILE" ]; then
            echo "‚ùå Êú™ÊâæÂà∞ rootfs artifact (*.tar.gz)"
            exit 1
          fi
          cp "$FILE" openwrt-armvirt-64-default-rootfs.tar.gz
          echo "ROOTFS_FILE=openwrt-armvirt-64-default-rootfs.tar.gz" >> $GITHUB_ENV

      - name: Mirror rootfs into tmp directory (compat)
        run: |
          mkdir -p tmp
          cp -f openwrt-armvirt-64-default-rootfs.tar.gz tmp/

      - name: Run packing script
        working-directory: .
        run: |
          ROOTFS_FILE="${{ env.ROOTFS_FILE }}"
          echo "üì¶ Packing image using: $ROOTFS_FILE"
          sudo ./mk_s905d_n1.sh _test

      - name: Verify image hash
        run: |
          EXPECTED="5CB8B5CFBCE9B3BA687862C13A5748A5A98C1B693D8C581032A6C0AE1A85ABA9"
          FILE=$(ls -1 output/*.img | head -n1)
          if [ -z "$FILE" ]; then
            echo "‚ùå No .img found in output/"
            ls -l output || true
            exit 1
          fi
          HASH=$(sha256sum "$FILE" | awk '{print $1}')
          HASH_UP=$(echo "$HASH" | tr '[:lower:]' '[:upper:]')
          echo "Image: $FILE"
          echo "SHA256: $HASH_UP"
          if [ "$HASH_UP" != "$EXPECTED" ]; then
            echo "‚ùå Hash mismatch"
            exit 1
          fi
          echo "‚úÖ Hash verified"

      - name: Upload packed image(s)
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-packed-image
          path: output/*.img
          if-no-files-found: error
