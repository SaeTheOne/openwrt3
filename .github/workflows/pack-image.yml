name: ğŸ“¦ Pack OpenWrt Image

on:
  workflow_call:
    inputs:
      rootfs_url:
        description: 'è¿œç¨‹ rootfs ä¸‹è½½ URLï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string
      rootfs_path:
        description: 'æ„å»ºç”Ÿæˆçš„ rootfs è·¯å¾„ï¼ˆç”¨äºåŒä»“è°ƒç”¨æ—¶çš„æç¤ºï¼Œä»…ç”¨äºæ—¥å¿—ï¼‰'
        required: false
        type: string
      whoami_content:
        description: 'openwrt_packit çš„ whoami æ–‡ä»¶å†…å®¹ï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string
      kernel_base_url:
        description: 'å†…æ ¸ tarball åŸºç¡€ URLï¼ˆé»˜è®¤ä¸º SaeTheOne/openwrt3 flippy_kernelï¼‰'
        required: false
        type: string
  workflow_dispatch:
    inputs:
      rootfs_url:
        description: 'è¿œç¨‹ rootfs ä¸‹è½½ URLï¼ˆå¯é€‰ï¼‰'
        required: false
        default: ''
      whoami_content:
        description: 'openwrt_packit çš„ whoami æ–‡ä»¶å†…å®¹ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: ''
      kernel_base_url:
        description: 'å†…æ ¸ tarball åŸºç¡€ URLï¼ˆé»˜è®¤ä¸º SaeTheOne/openwrt3 flippy_kernelï¼‰'
        required: false
        default: 'https://raw.githubusercontent.com/SaeTheOne/openwrt3/main/flippy_kernel'

jobs:
  pack:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout openwrt_packit
        uses: actions/checkout@v4
        with:
          repository: unifreq/openwrt_packit
          path: ./openwrt_packit

      - name: Write whoami file
        run: |
          if [ -n "${{ inputs.whoami_content }}" ]; then
            CONTENT="${{ inputs.whoami_content }}"
            printf "%s\n" "$CONTENT" > ./openwrt_packit/whoami
          else
            # ä»è°ƒç”¨ä»“åº“é»˜è®¤åˆ†æ”¯æ‹‰å– whoamiï¼ˆå¦‚å¤±è´¥åˆ™ä¿æŒç©ºï¼‰
            REPO="${GITHUB_REPOSITORY}"
            BRANCH="main"
            URL="https://raw.githubusercontent.com/${REPO}/${BRANCH}/flippy_kernel/whoami"
            echo "å°è¯•è·å– whoami: $URL"
            curl -fsSL "$URL" -o ./openwrt_packit/whoami || true
          fi

          echo "å½“å‰ whoami å†…å®¹:"
          cat ./openwrt_packit/whoami || true

      - name: Prepare kernel files based on whoami
        env:
          KERNEL_BASE_URL: ${{ inputs.kernel_base_url }}
        run: |
          set -e
          KERNEL_VERSION=$(grep '^KERNEL_VERSION=' ./openwrt_packit/whoami | cut -d'=' -f2)
          if [ -z "$KERNEL_VERSION" ]; then
            echo "æœªåœ¨ whoami ä¸­æ‰¾åˆ° KERNEL_VERSION"
            exit 1
          fi
          BASE_URL=${KERNEL_BASE_URL:-https://raw.githubusercontent.com/SaeTheOne/openwrt3/main/flippy_kernel}
          echo "ä½¿ç”¨å†…æ ¸ç‰ˆæœ¬: $KERNEL_VERSION"
          echo "å†…æ ¸æ¥æº: $BASE_URL"
          sudo mkdir -p /opt/kernel
          cd /tmp
          for f in \
            "boot-$KERNEL_VERSION.tar.gz" \
            "dtb-allwinner-$KERNEL_VERSION.tar.gz" \
            "dtb-amlogic-$KERNEL_VERSION.tar.gz" \
            "dtb-rockchip-$KERNEL_VERSION.tar.gz" \
            "header-$KERNEL_VERSION.tar.gz" \
            "modules-$KERNEL_VERSION.tar.gz"; do
            echo "ä¸‹è½½: $BASE_URL/$f"
            curl -fsSL "$BASE_URL/$f" -o "$f"
            sudo cp "$f" /opt/kernel/
          done

      - name: Download rootfs from URL
        if: ${{ inputs.rootfs_url != '' }}
        run: |
          URL="${{ inputs.rootfs_url }}"
          echo "ğŸ“¥ ä» URL ä¸‹è½½ rootfs: $URL"
          # ä»URLä¸­æå–åŸå§‹æ–‡ä»¶åï¼Œä¿ç•™æ–‡ä»¶çš„åŸå§‹åç§°
          ORIGINAL_NAME=$(basename "$URL")
          curl -fsSL "$URL" -o "$ORIGINAL_NAME"
          echo "ROOTFS_FILE=$ORIGINAL_NAME" >> $GITHUB_ENV

      - name: Download rootfs artifact (fallback)
        if: ${{ inputs.rootfs_url == '' }}
        uses: actions/download-artifact@v4
        with:
          path: ./artifact_rootfs
          pattern: "*.tar.gz"
          merge-multiple: true

      - name: Prepare rootfs from artifact
        if: ${{ inputs.rootfs_url == '' }}
        run: |
          set -e
          FILE=$(find ./artifact_rootfs -type f -name "*.tar.gz" | head -n1)
          if [ -z "$FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ° rootfs artifact (*.tar.gz)"
            exit 1
          fi
          # è·å–åŸå§‹æ–‡ä»¶å
          ORIGINAL_NAME=$(basename "$FILE")
          echo "ğŸ“ åŸå§‹rootfsæ–‡ä»¶å: $ORIGINAL_NAME"
          
          # æå–name1ï¼šåˆ é™¤-generic-rootfs.tar.gzéƒ¨åˆ†
          NAME1=${ORIGINAL_NAME%-generic-rootfs.tar.gz}
          NAME1=${NAME1%-rootfs.tar.gz} # é¢å¤–å¤„ç†å¯èƒ½çš„-rootfs.tar.gzåç¼€
          echo "âœ… æå–çš„NAME1: $NAME1"
          
          # å…³é”®ä¿®æ”¹ï¼šå¤åˆ¶æ–‡ä»¶åˆ°openwrt_packitç›®å½•ä¸‹å¹¶é‡å‘½åä¸ºopenwrt-armvirt-64-default-rootfs.tar.gz
          cp "$FILE" "./openwrt_packit/openwrt-armvirt-64-default-rootfs.tar.gz"
          echo "ROOTFS_FILE=openwrt-armvirt-64-default-rootfs.tar.gz" >> $GITHUB_ENV
          echo "NAME1=$NAME1" >> $GITHUB_ENV
          
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          ls -la "./openwrt_packit/openwrt-armvirt-64-default-rootfs.tar.gz"



      - name: Record rootfs metadata
        run: |
          if [ -n "${{ inputs.rootfs_url }}" ]; then
            ORIGINAL_NAME=$(basename "${{ inputs.rootfs_url }}")
          else
            ORIGINAL_NAME=$(basename $(find ./artifact_rootfs -type f -name "*.tar.gz" | head -n1))
          fi
          KERNEL_VERSION=$(grep '^KERNEL_VERSION=' ./openwrt_packit/whoami | cut -d'=' -f2)
          {
            echo "original_rootfs_name=$ORIGINAL_NAME";
            echo "kernel_version=$KERNEL_VERSION";
            echo "whoami:";
            cat ./openwrt_packit/whoami;
          } > rootfs-meta.txt
          BASE=${ORIGINAL_NAME%.tar.gz}
          BASE=${BASE%-generic-rootfs}
          BASE=${BASE%-rootfs}
          echo "PACKED_ARTIFACT_NAME=${BASE}-packed-image" >> $GITHUB_ENV

      - name: Upload rootfs metadata
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-rootfs-for-packing-meta
          path: rootfs-meta.txt

      - name: å‡†å¤‡æ‰“åŒ…ç¯å¢ƒ
        run: |
          # ç¡®ä¿ä½¿ç”¨bashæ‰§è¡Œè„šæœ¬ï¼Œè€Œä¸æ˜¯é»˜è®¤çš„dash
          echo "SHELL=$(which bash)" >> $GITHUB_ENV
          
          # æ£€æŸ¥openwrt_packitç›®å½•ç»“æ„
          echo "ğŸ“‚ openwrt_packitç›®å½•å†…å®¹:"
          ls -la ./openwrt_packit
          
          # ç»™æ‰€æœ‰è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
          chmod +x ./openwrt_packit/*.sh
          
          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨å…¶ä»–å¿…è¦çš„è„šæœ¬æ–‡ä»¶
          echo "ğŸ” æ£€æŸ¥å¿…è¦çš„è„šæœ¬æ–‡ä»¶:"
          ls -la ./openwrt_packit/lib/ 2>/dev/null || echo "libç›®å½•ä¸å­˜åœ¨"
      
      - name: Run packing script
        working-directory: ./openwrt_packit
        shell: bash {0}  # æ˜¾å¼ä½¿ç”¨bashæ‰§è¡Œè„šæœ¬
        run: |
          ROOTFS_FILE="${{ env.ROOTFS_FILE }}"
          NAME1="${{ env.NAME1 }}"
          TODAY_DATE=$(date +"%Y%m%d")
          echo "ğŸ“¦ Packing image using: $ROOTFS_FILE"  # ç›´æ¥ä½¿ç”¨å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶
          echo "ğŸ“ NAME1: $NAME1, æ—¥æœŸ: $TODAY_DATE"
          
          # å…³é”®è°ƒè¯•ï¼šæ˜¾ç¤ºè¯¦ç»†çš„ç›®å½•ç»“æ„ä¿¡æ¯
          echo "ğŸ“ å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ğŸ“ ä¸Šçº§ç›®å½•: $(cd .. && pwd)"
          echo "ğŸ“ æ ¹ç›®å½•: /"
          echo "ğŸ“ ç¯å¢ƒå˜é‡GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          
          # æ˜¾ç¤ºç›®å½•å±‚æ¬¡ç»“æ„
          echo "ğŸ“‚ ç›®å½•å±‚æ¬¡ç»“æ„:"
          find .. -type d -maxdepth 2 | sort
          
          # ç¡®ä¿ä¸´æ—¶ç›®å½•ä¸å­˜åœ¨
          sudo rm -rf tmp/* 2>/dev/null || true
          mkdir -p tmp
          
          # æ£€æŸ¥rootfsæ–‡ä»¶æ˜¯å¦å­˜åœ¨å¹¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
          echo "ğŸ” æ£€æŸ¥rootfsæ–‡ä»¶: ./$ROOTFS_FILE"
          if [ -f "./$ROOTFS_FILE" ]; then
            echo "âœ… æ–‡ä»¶å­˜åœ¨ï¼Œå¤§å°: $(du -h ./$ROOTFS_FILE | cut -f1)"
          else
            echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨ï¼æ­£åœ¨æœç´¢æ‰€æœ‰å¯ç”¨çš„tar.gzæ–‡ä»¶..."
            find . -name "*.tar.gz" -type f | xargs ls -la
          fi
          
          # å¤åˆ¶rootfsåˆ°openwrt_packitçš„tmpç›®å½•
          cp -f ./$ROOTFS_FILE tmp/ || echo "âŒ å¤åˆ¶æ–‡ä»¶å¤±è´¥ï¼"
          
          # å…³é”®ä¿®å¤ï¼šåˆ›å»ºè„šæœ¬æœŸæœ›çš„å¤šä¸ªrootfsæ–‡ä»¶åå‰¯æœ¬
          # ä»é”™è¯¯ä¿¡æ¯çœ‹ï¼Œè„šæœ¬å¯èƒ½åœ¨å¯»æ‰¾ç‰¹å®šå‘½åçš„rootfsæ–‡ä»¶
          ROOTFS_BASENAME=$(basename "$ROOTFS_FILE")
          
          # å¤åˆ¶åˆ°å¤šä¸ªå¯èƒ½çš„ä½ç½®å’Œåç§°ï¼Œç¡®ä¿è„šæœ¬èƒ½æ‰¾åˆ°
          cp -f ./$ROOTFS_FILE tmp/rootfs.tar.gz      # æœ€åŸºç¡€çš„åç§°
          cp -f ./$ROOTFS_FILE tmp/openwrt_rootfs.tar.gz  # å¯èƒ½çš„é»˜è®¤åç§°
          cp -f ./$ROOTFS_FILE tmp/openwrt-armvirt-64-rootfs.tar.gz  # æ¶æ„ç›¸å…³åç§°
          cp -f ./$ROOTFS_FILE tmp/openwrt-rootfs.tar.gz  # å½“å‰ç›®å½•ä¸‹çš„tmpç›®å½•
          cp -f ./$ROOTFS_FILE ./rootfs.tar.gz  # ç›´æ¥å¤åˆ¶åˆ°å½“å‰ç›®å½•
          
          # æ˜¾ç¤ºtmpç›®å½•å†…å®¹ï¼Œç”¨äºè°ƒè¯•
          echo "ğŸ“‚ tmpç›®å½•å†…å®¹:"
          ls -la tmp/
          echo "ğŸ“‚ å½“å‰ç›®å½•å†…å®¹:"
          ls -la
          
          # ä¿®æ”¹mk_s905d_n1.shè„šæœ¬ï¼Œç¡®ä¿mkdirå‘½ä»¤ä½¿ç”¨-på‚æ•°
          sed -i 's/mkdir /mkdir -p /g' ./mk_s905d_n1.sh
          
          # æ˜¾ç¤ºget_openwrt_rootfs_archiveå‡½æ•°çš„å®ç°ï¼Œå¸®åŠ©è¯Šæ–­
          echo "ğŸ” get_openwrt_rootfs_archiveå‡½æ•°å®ç°:"
          grep -n -A 20 "get_openwrt_rootfs_archive" ./mk_s905d_n1.sh || echo "æœªæ‰¾åˆ°get_openwrt_rootfs_archiveå‡½æ•°"
          
          # ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
          chmod +x ./mk_s905d_n1.sh
          
          # å…³é”®ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨å®é™…çš„rootfsæ–‡ä»¶è·¯å¾„
          ACTUAL_ROOTFS_PATH="${PWD}/../openwrt-armvirt-64-default-rootfs.tar.gz"
          echo "ğŸ”§ åœ¨mk_s905d_n1.shè„šæœ¬å¼€å¤´è®¾ç½®OPWRT_ROOTFS_GZ=$ACTUAL_ROOTFS_PATH"
          
          # æ£€æŸ¥å¹¶åˆ›å»ºå¿…è¦çš„ç›®å½•
          mkdir -p lib tmp output
          
          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨å¿…è¦çš„åº“æ–‡ä»¶
          if [ ! -f ./lib/_common.sh ]; then
            echo "âš ï¸  _common.shæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°è¯•ä»ä»“åº“è·å–..."
            # ä»unifreq/openwrt_packitä»“åº“ä¸‹è½½å¿…è¦çš„åº“æ–‡ä»¶
            curl -fsSL "https://raw.githubusercontent.com/unifreq/openwrt_packit/main/lib/_common.sh" -o ./lib/_common.sh || echo "âŒ ä¸‹è½½_common.shå¤±è´¥"
          fi
          
          # ç¡®ä¿æ‰€æœ‰åº“æ–‡ä»¶éƒ½æœ‰æ‰§è¡Œæƒé™
          chmod +x ./lib/*.sh 2>/dev/null || true
          
          # ä¿®æ”¹è„šæœ¬ä½¿ç”¨bashæ‰§è¡Œ
          sed -i '1i #!/bin/bash' ./mk_s905d_n1.sh
          
          # åœ¨è„šæœ¬å¼€å¤´è®¾ç½®OPWRT_ROOTFS_GZå˜é‡
          sed -i '1i OPWRT_ROOTFS_GZ="'"$ACTUAL_ROOTFS_PATH"'"' ./mk_s905d_n1.sh
          
          # åŒæ—¶ä¿ç•™ç¯å¢ƒå˜é‡è®¾ç½®ï¼ŒåŒé‡ä¿é™©
          export OPWRT_ROOTFS_GZ="$ACTUAL_ROOTFS_PATH"
          echo "ğŸ”§ è®¾ç½®ç¯å¢ƒå˜é‡OPWRT_ROOTFS_GZ=$OPWRT_ROOTFS_GZ"
          
          # åœ¨è„šæœ¬å†…éƒ¨ä¹Ÿæ·»åŠ OPWRT_ROOTFS_GZå˜é‡æ£€æŸ¥å’Œè®¾ç½®
          # æ‰¾åˆ°get_openwrt_rootfs_archiveå‡½æ•°å¹¶åœ¨å…¶ä¸­æ·»åŠ ç›´æ¥è¿”å›å˜é‡å€¼çš„é€»è¾‘
          if grep -q "get_openwrt_rootfs_archive" ./mk_s905d_n1.sh; then
            echo "ğŸ”§ ä¿®æ”¹get_openwrt_rootfs_archiveå‡½æ•°ï¼Œä¼˜å…ˆä½¿ç”¨OPWRT_ROOTFS_GZç¯å¢ƒå˜é‡"
            # åœ¨å‡½æ•°å¼€å¤´æ·»åŠ æ£€æŸ¥OPWRT_ROOTFS_GZå˜é‡çš„é€»è¾‘
            sed -i '/get_openwrt_rootfs_archive()/a \    if [ -n "$OPWRT_ROOTFS_GZ" ] && [ -f "$OPWRT_ROOTFS_GZ" ]; then\n        echo "$OPWRT_ROOTFS_GZ"\n        return 0\n    fi' ./mk_s905d_n1.sh
          fi
          
          # ç›´æ¥ä¿®æ”¹è„šæœ¬ï¼Œåœ¨ä»»ä½•åœ°æ–¹æŸ¥æ‰¾rootfsæ–‡ä»¶å‰éƒ½å…ˆæ£€æŸ¥OPWRT_ROOTFS_GZ
          echo "ğŸ”§ åœ¨è„šæœ¬ä¸­æ·»åŠ å…¨å±€rootfsè·¯å¾„æ£€æŸ¥"
          # åœ¨è„šæœ¬å¼€å¤´æ·»åŠ å¤šä¸ªrootfsè·¯å¾„çš„æ£€æŸ¥å’Œè®¾ç½®
          cat << 'EOF' > ./rootfs_finder.sh
          #!/bin/bash
          
          # æŸ¥æ‰¾rootfsæ–‡ä»¶çš„æ‰€æœ‰å¯èƒ½ä½ç½®
          check_rootfs_location() {
              local locations=("$1" "../openwrt-armvirt-64-default-rootfs.tar.gz" "./openwrt_rootfs.tar.gz" "./rootfs.tar.gz" "tmp/rootfs.tar.gz" "tmp/openwrt_rootfs.tar.gz")
              
              for loc in "${locations[@]}"; do
                  if [ -f "$loc" ]; then
                      echo "âœ… æ‰¾åˆ°rootfsæ–‡ä»¶åœ¨: $loc"
                      return 0
                  fi
              done
              
              return 1
          }
          
          # è¿è¡Œæ£€æŸ¥
          if ! check_rootfs_location "$OPWRT_ROOTFS_GZ"; then
              echo "âŒ æœªæ‰¾åˆ°rootfsæ–‡ä»¶! å°è¯•å¤åˆ¶å½“å‰ä½ç½®çš„æ–‡ä»¶..."
              # å°è¯•ä»ä¸Šçº§ç›®å½•å¤åˆ¶
              cp -f ../openwrt-armvirt-64-default-rootfs.tar.gz ./openwrt_rootfs.tar.gz 2>/dev/null || echo "å¤åˆ¶å¤±è´¥"
              cp -f ../openwrt-armvirt-64-default-rootfs.tar.gz ./rootfs.tar.gz 2>/dev/null || echo "å¤åˆ¶å¤±è´¥"
          fi
          EOF
          
          chmod +x ./rootfs_finder.sh
          
          # æ˜¾ç¤ºä¿®æ”¹åçš„è„šæœ¬å¼€å¤´å‡ è¡Œï¼Œç¡®è®¤è®¾ç½®æˆåŠŸ
          echo "ğŸ“ ä¿®æ”¹åçš„è„šæœ¬å¼€å¤´å‡ è¡Œ:"
          head -n 15 ./mk_s905d_n1.sh
          
          # ç²¾ç¡®è°ƒè¯•ï¼šæ£€æŸ¥æ‰§è¡Œæ—¶çš„ç¯å¢ƒå˜é‡å€¼
          echo "ğŸ” æ‰§è¡Œå‰ç¯å¢ƒå˜é‡æ£€æŸ¥:"
          env | grep -E 'OPWRT|ROOTFS|SHELL'
          echo "ğŸ” å®é™…rootfsæ–‡ä»¶è·¯å¾„æ£€æŸ¥:"
          ls -la "$ACTUAL_ROOTFS_PATH" || echo "æ–‡ä»¶ä¸å­˜åœ¨"
          echo "ğŸ” ä¸Šçº§ç›®å½•æ–‡ä»¶æ£€æŸ¥:"
          ls -la ../ | grep rootfs
          
          # æ£€æŸ¥åº“æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          echo "ğŸ“ æ£€æŸ¥åº“æ–‡ä»¶:"
          ls -la ./lib/ 2>/dev/null || echo "libç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º"
          
          # å®‰è£…å¿…è¦çš„ä¾èµ–
          echo "ğŸ“¦ å®‰è£…å¿…è¦çš„ä¾èµ–..."
          sudo apt-get update
          sudo apt-get install -y btrfs-progs dosfstools mtools parted squashfs-tools
          
          # è¿è¡Œæ‰“åŒ…è„šæœ¬ï¼Œæ·»åŠ è°ƒè¯•è¾“å‡º
          echo "ğŸš€ è¿è¡Œæ‰“åŒ…è„šæœ¬..."
          SCRIPT_EXIT_CODE=0
          # è¿è¡ŒrootfsæŸ¥æ‰¾è„šæœ¬
          ./rootfs_finder.sh
          
          # é¢å¤–è®¾ç½®ç¯å¢ƒå˜é‡å¹¶ä¼ é€’ç»™sudo
          echo "ğŸ”§ ä½¿ç”¨sudo -Eç¡®ä¿ç¯å¢ƒå˜é‡æ­£ç¡®ä¼ é€’"
          sudo -E OPWRT_ROOTFS_GZ="$ACTUAL_ROOTFS_PATH" bash ./mk_s905d_n1.sh _test 2>&1 | tee packing.log || SCRIPT_EXIT_CODE=$?
          
          echo "ğŸ“Š æ‰“åŒ…è„šæœ¬æ‰§è¡ŒçŠ¶æ€ç : $SCRIPT_EXIT_CODE"
          
          # æ˜¾ç¤ºpacking.logçš„å…³é”®éƒ¨åˆ†ï¼Œå¸®åŠ©è¯Šæ–­é”™è¯¯
          echo "ğŸ“ æ‰“åŒ…æ—¥å¿—å…³é”®ä¿¡æ¯:" 
          grep -E 'error|failed|not found|warning' packing.log || echo "æœªå‘ç°æ˜æ˜¾é”™è¯¯ä¿¡æ¯"
          
          # æ˜¾ç¤ºå½“å‰ç›®å½•ç»“æ„ï¼ŒæŸ¥çœ‹æ‰€æœ‰å¯èƒ½çš„è¾“å‡ºä½ç½®
          echo "ğŸ“‚ å½“å‰ç›®å½•ç»“æ„:" 
          find . -type f -name "*.img" 2>/dev/null || echo "æœªæ‰¾åˆ°ä»»ä½•.imgæ–‡ä»¶"
          
          # æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„è¾“å‡ºç›®å½•
          echo "ğŸ“‚ æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„è¾“å‡ºä½ç½®:" 
          ls -la ./ 2>/dev/null
          ls -la ./output/ 2>/dev/null || echo "outputç›®å½•ä¸å­˜åœ¨"
          ls -la ./tmp/ 2>/dev/null || echo "tmpç›®å½•ä¸å­˜åœ¨"
          
          # é‡ç‚¹ï¼šåªåœ¨outputç›®å½•ä¸‹æœç´¢ç”Ÿæˆçš„é•œåƒæ–‡ä»¶
          echo "ğŸ” åœ¨outputç›®å½•ä¸‹æœç´¢ç”Ÿæˆçš„imgæ–‡ä»¶..."
          mkdir -p output  # ç¡®ä¿outputç›®å½•å­˜åœ¨
          
          # ä¼˜å…ˆåœ¨outputç›®å½•ä¸‹æŸ¥æ‰¾å¤§çš„é•œåƒæ–‡ä»¶
          IMG_FILE=$(find ./output -name "*.img" -type f -size +100M 2>/dev/null | head -n 1)
          
          # å¦‚æœoutputç›®å½•ä¸‹æ²¡æ‰¾åˆ°å¤§çš„imgæ–‡ä»¶ï¼Œå°è¯•æŸ¥æ‰¾outputç›®å½•ä¸‹çš„ä»»ä½•imgæ–‡ä»¶
          if [ -z "$IMG_FILE" ]; then
            echo "âš ï¸  åœ¨outputç›®å½•ä¸‹æœªæ‰¾åˆ°å¤§çš„imgæ–‡ä»¶ï¼Œå°è¯•æŸ¥æ‰¾outputç›®å½•ä¸‹çš„ä»»ä½•imgæ–‡ä»¶..."
            IMG_FILE=$(find ./output -name "*.img" -type f 2>/dev/null | head -n 1)
          fi
          
          # è¾“å‡ºoutputç›®å½•çš„è¯¦ç»†å†…å®¹ï¼Œå¸®åŠ©è°ƒè¯•
          echo "ğŸ“ outputç›®å½•å†…å®¹è¯¦æƒ…ï¼š"
          ls -la ./output/
          
          if [ -n "$IMG_FILE" ]; then
            echo "âœ… æ‰¾åˆ°imgæ–‡ä»¶: $IMG_FILE"
            # é‡å‘½åimgæ–‡ä»¶ä¸ºname1+æ—¥æœŸ+.imgæ ¼å¼
            NEW_IMG_NAME="${NAME1}-${TODAY_DATE}.img"
            cp "$IMG_FILE" "output/$NEW_IMG_NAME"
            echo "âœ… å·²é‡å‘½åimgæ–‡ä»¶: $NEW_IMG_NAME"
            echo "FINAL_IMG_NAME=$NEW_IMG_NAME" >> $GITHUB_ENV
          else
            echo "âŒ æœªæ‰¾åˆ°ç”Ÿæˆçš„imgæ–‡ä»¶"
            # å³ä½¿å¤±è´¥ä¹Ÿå°è¯•ç»§ç»­ï¼Œä»¥ä¾¿ä¸Šä¼ è°ƒè¯•ä¿¡æ¯
            echo "âš ï¸  å°è¯•ç»§ç»­æ‰§è¡Œä»¥æ”¶é›†æ›´å¤šè°ƒè¯•ä¿¡æ¯..."
          fi


      - name: Upload packed image(s)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FINAL_IMG_NAME || 'packed-image' }}
          path: ./openwrt_packit/output/${{ env.FINAL_IMG_NAME || '*.img' }}
          if-no-files-found: error
      
      - name: Check if release should be uploaded
        id: check_release
        env:
          UPLOAD_RELEASE: ${{ inputs.upload_release || 'true' }}
        run: |
          if [ "$UPLOAD_RELEASE" = "true" ]; then
            echo "upload=true" >> $GITHUB_OUTPUT
          else
            echo "upload=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate release tag
        if: ${{ steps.check_release.outputs.upload == 'true' }}
        id: tag
        run: |
          echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT

      - name: Upload to GitHub Release
        if: ${{ steps.check_release.outputs.upload == 'true' }}
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          files: |
            ./openwrt_packit/output/*.img
          body: |
            Built from ImmortalWrt
            Package SoC: s905d
            Kernel: ${{ env.KERNEL_VERSION || 'Unknown' }}
