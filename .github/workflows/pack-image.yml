name: ğŸ“¦ Pack OpenWrt/istoreOS Image

on:
  workflow_call:
    inputs:
      rootfs_url:
        description: 'è¿œç¨‹ rootfs ä¸‹è½½ URLï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string
      rootfs_path:
        description: 'æ„å»ºç”Ÿæˆçš„ rootfs è·¯å¾„ï¼ˆç”¨äºåŒä»“è°ƒç”¨æ—¶çš„æç¤ºï¼Œä»…ç”¨äºæ—¥å¿—ï¼‰'
        required: false
        type: string
      whoami_content:
        description: 'openwrt_packit çš„ whoami æ–‡ä»¶å†…å®¹ï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string
      kernel_base_url:
        description: 'å†…æ ¸ tarball åŸºç¡€ URLï¼ˆé»˜è®¤ä¸º SaeTheOne/openwrt3 flippy_kernelï¼‰'
        required: false
        type: string
  workflow_dispatch:
    inputs:
      rootfs_url:
        description: 'è¿œç¨‹ rootfs ä¸‹è½½ URLï¼ˆå¯é€‰ï¼‰'
        required: false
        default: ''
      whoami_content:
        description: 'openwrt_packit çš„ whoami æ–‡ä»¶å†…å®¹ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: ''
      kernel_base_url:
        description: 'å†…æ ¸ tarball åŸºç¡€ URLï¼ˆé»˜è®¤ä¸º SaeTheOne/openwrt3 flippy_kernelï¼‰'
        required: false
        default: 'https://raw.githubusercontent.com/SaeTheOne/openwrt3/main/flippy_kernel'

jobs:
  pack:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout openwrt_packit
        uses: actions/checkout@v4
        with:
          repository: unifreq/openwrt_packit
          path: ./openwrt_packit

      - name: Write whoami file
        run: |
          if [ -n "${{ inputs.whoami_content }}" ]; then
            CONTENT="${{ inputs.whoami_content }}"
            printf "%s\n" "$CONTENT" > ./openwrt_packit/whoami
          else
            # ä»è°ƒç”¨ä»“åº“é»˜è®¤åˆ†æ”¯æ‹‰å– whoamiï¼ˆå¦‚å¤±è´¥åˆ™ä¿æŒç©ºï¼‰
            REPO="${GITHUB_REPOSITORY}"
            BRANCH="main"
            URL="https://raw.githubusercontent.com/${REPO}/${BRANCH}/flippy_kernel/whoami"
            echo "å°è¯•è·å– whoami: $URL"
            curl -fsSL "$URL" -o ./openwrt_packit/whoami || true
          fi

          echo "å½“å‰ whoami å†…å®¹:"
          cat ./openwrt_packit/whoami || true

      - name: Prepare kernel files based on whoami
        env:
          KERNEL_BASE_URL: ${{ inputs.kernel_base_url }}
        run: |
          set -e
          KERNEL_VERSION=$(grep '^KERNEL_VERSION=' ./openwrt_packit/whoami | cut -d'=' -f2)
          if [ -z "$KERNEL_VERSION" ]; then
            echo "æœªåœ¨ whoami ä¸­æ‰¾åˆ° KERNEL_VERSION"
            exit 1
          fi
          BASE_URL=${KERNEL_BASE_URL:-https://raw.githubusercontent.com/SaeTheOne/openwrt3/main/flippy_kernel}
          echo "ä½¿ç”¨å†…æ ¸ç‰ˆæœ¬: $KERNEL_VERSION"
          echo "å†…æ ¸æ¥æº: $BASE_URL"
          sudo mkdir -p /opt/kernel
          cd /tmp
          for f in \
            "boot-$KERNEL_VERSION.tar.gz" \
            "dtb-allwinner-$KERNEL_VERSION.tar.gz" \
            "dtb-amlogic-$KERNEL_VERSION.tar.gz" \
            "dtb-rockchip-$KERNEL_VERSION.tar.gz" \
            "header-$KERNEL_VERSION.tar.gz" \
            "modules-$KERNEL_VERSION.tar.gz"; do
            echo "ä¸‹è½½: $BASE_URL/$f"
            curl -fsSL "$BASE_URL/$f" -o "$f"
            sudo cp "$f" /opt/kernel/
          done

      - name: Download rootfs from URL
        if: ${{ inputs.rootfs_url != '' }}
        run: |
          URL="${{ inputs.rootfs_url }}"
          echo "ğŸ“¥ ä» URL ä¸‹è½½ rootfs: $URL"
          # ä»URLä¸­æå–åŸå§‹æ–‡ä»¶åï¼Œä¿ç•™æ–‡ä»¶çš„åŸå§‹åç§°
          ORIGINAL_NAME=$(basename "$URL")
          curl -fsSL "$URL" -o "$ORIGINAL_NAME"
          echo "ROOTFS_FILE=$ORIGINAL_NAME" >> $GITHUB_ENV

      - name: Download rootfs artifact (fallback)
        if: ${{ inputs.rootfs_url == '' }}
        uses: actions/download-artifact@v4
        with:
          path: ./artifact_rootfs
          pattern: "*.tar.gz"
          merge-multiple: true

      - name: Prepare rootfs from artifact
        if: ${{ inputs.rootfs_url == '' }}
        run: |
          set -e
          FILE=$(find ./artifact_rootfs -type f -name "*.tar.gz" | head -n1)
          if [ -z "$FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ° rootfs artifact (*.tar.gz)"
            exit 1
          fi
          # è·å–åŸå§‹æ–‡ä»¶å
          ORIGINAL_NAME=$(basename "$FILE")
          echo "ğŸ“ åŸå§‹rootfsæ–‡ä»¶å: $ORIGINAL_NAME"
          
          # æå–name1ï¼šåˆ é™¤-generic-rootfs.tar.gzéƒ¨åˆ†
          NAME1=${ORIGINAL_NAME%-generic-rootfs.tar.gz}
          NAME1=${NAME1%-rootfs.tar.gz} # é¢å¤–å¤„ç†å¯èƒ½çš„-rootfs.tar.gzåç¼€
          echo "âœ… æå–çš„NAME1: $NAME1"
          
          # å¤åˆ¶æ–‡ä»¶å¹¶é‡å‘½åä¸ºopenwrt-armvirt-64-default-rootfs.tar.gz
          cp "$FILE" "openwrt-armvirt-64-default-rootfs.tar.gz"
          echo "ROOTFS_FILE=openwrt-armvirt-64-default-rootfs.tar.gz" >> $GITHUB_ENV
          echo "NAME1=$NAME1" >> $GITHUB_ENV
          
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          ls -la "openwrt-armvirt-64-default-rootfs.tar.gz"

      - name: Mirror rootfs into tmp directory (compat)
        run: |
          mkdir -p tmp
          cp -f "${{ env.ROOTFS_FILE }}" tmp/
          echo "âœ… Rootfsæ–‡ä»¶å·²å¤åˆ¶åˆ°tmpç›®å½•: tmp/${{ env.ROOTFS_FILE }}"

      - name: Record rootfs metadata
        run: |
          if [ -n "${{ inputs.rootfs_url }}" ]; then
            ORIGINAL_NAME=$(basename "${{ inputs.rootfs_url }}")
          else
            ORIGINAL_NAME=$(basename $(find ./artifact_rootfs -type f -name "*.tar.gz" | head -n1))
          fi
          KERNEL_VERSION=$(grep '^KERNEL_VERSION=' ./openwrt_packit/whoami | cut -d'=' -f2)
          {
            echo "original_rootfs_name=$ORIGINAL_NAME";
            echo "kernel_version=$KERNEL_VERSION";
            echo "whoami:";
            cat ./openwrt_packit/whoami;
          } > rootfs-meta.txt
          BASE=${ORIGINAL_NAME%.tar.gz}
          BASE=${BASE%-generic-rootfs}
          BASE=${BASE%-rootfs}
          echo "PACKED_ARTIFACT_NAME=${BASE}-packed-image" >> $GITHUB_ENV

      - name: Upload rootfs metadata
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-rootfs-for-packing-meta
          path: rootfs-meta.txt

      - name: Run packing script
        working-directory: ./openwrt_packit
        run: |
          ROOTFS_FILE="${{ env.ROOTFS_FILE }}"
          NAME1="${{ env.NAME1 }}"
          TODAY_DATE=$(date +"%Y%m%d")
          echo "ğŸ“¦ Packing image using: ../$ROOTFS_FILE"
          echo "ğŸ“ NAME1: $NAME1, æ—¥æœŸ: $TODAY_DATE"
          
          # ç¡®ä¿ä¸´æ—¶ç›®å½•ä¸å­˜åœ¨
          sudo rm -rf tmp/* 2>/dev/null || true
          mkdir -p tmp
          
          # å¤åˆ¶rootfsåˆ°openwrt_packitçš„tmpç›®å½•
          cp -f ../$ROOTFS_FILE tmp/
          
          # ä¿®æ”¹mk_s905d_n1.shè„šæœ¬ï¼Œç¡®ä¿mkdirå‘½ä»¤ä½¿ç”¨-på‚æ•°
          sed -i 's/mkdir /mkdir -p /g' ./mk_s905d_n1.sh
          
          # è¿è¡Œæ‰“åŒ…è„šæœ¬
          sudo ./mk_s905d_n1.sh _test
          
          # æ˜¾ç¤ºç”Ÿæˆçš„imgæ–‡ä»¶
          echo "ğŸ“‚ ç”Ÿæˆçš„imgæ–‡ä»¶:" 
          ls -la output/*.img
          
          # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†imgæ–‡ä»¶
          if [ -f output/*.img ]; then
            # è·å–ç”Ÿæˆçš„imgæ–‡ä»¶
            GENERATED_IMG=$(ls output/*.img | head -n1)
            # é‡å‘½åimgæ–‡ä»¶ä¸ºname1+æ—¥æœŸ+.imgæ ¼å¼
            NEW_IMG_NAME="${NAME1}-${TODAY_DATE}.img"
            cp "$GENERATED_IMG" "output/$NEW_IMG_NAME"
            echo "âœ… å·²é‡å‘½åimgæ–‡ä»¶: $NEW_IMG_NAME"
            echo "FINAL_IMG_NAME=$NEW_IMG_NAME" >> $GITHUB_ENV
          else
            echo "âŒ æœªæ‰¾åˆ°ç”Ÿæˆçš„imgæ–‡ä»¶"
            exit 1
          fi


      - name: Upload packed image(s)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FINAL_IMG_NAME || 'packed-image' }}
          path: ./openwrt_packit/output/${{ env.FINAL_IMG_NAME || '*.img' }}
          if-no-files-found: error
