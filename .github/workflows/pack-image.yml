# .github/workflows/pack-image.yml
name: Pack OpenWrt / ImmortalWrt Image

on:
  workflow_call:

jobs:
  pack:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout packit tool
        run: |
          git clone --depth=1 https://github.com/unifreq/openwrt_packit.git
          chmod +x openwrt_packit/make_ext4fs

      - name: Try to download pre-built rootfs artifact (for testing)
        id: download_artifact
        uses: actions/download-artifact@v4
        with:
          name: openwrt-rootfs-for-packing
        continue-on-error: true  # å…³é”®ï¼å¦‚æœæ²¡ artifact å°±è·³è¿‡

      - name: Determine rootfs path
        id: set_rootfs
        run: |
          if [ -f "rootfs.tar.gz" ]; then
            echo "ROOTFS_PATH=$(pwd)/rootfs.tar.gz" >> $GITHUB_OUTPUT
            echo "âœ… Using pre-uploaded rootfs from artifact"
          elif [ -f "../openwrt-rootfs-for-packing/rootfs.tar.gz" ]; then
            # å…¼å®¹æŸäº›æ—§æ–¹å¼ä¸Šä¼ çš„ artifact ç»“æ„
            echo "ROOTFS_PATH=$(pwd)/../openwrt-rootfs-for-packing/rootfs.tar.gz" >> $GITHUB_OUTPUT
          else
            # ä¸»æµç¨‹ï¼šä½¿ç”¨ç¼–è¯‘ç”Ÿæˆçš„ rootfsï¼ˆå‡è®¾åœ¨ä¸Šå±‚ç›®å½•ï¼‰
            echo "ROOTFS_PATH=$(pwd)/../immortalwrt/bin/targets/armsr/armv8/immortalwrt-24.10.4-armsr-armv8-generic-rootfs.tar.gz" >> $GITHUB_OUTPUT
            echo "âš ï¸ No pre-uploaded rootfs found, using compiled one"
          fi

      - name: Verify rootfs exists
        run: |
          ROOTFS="${{ steps.set_rootfs.outputs.ROOTFS_PATH }}"
          if [ ! -f "$ROOTFS" ]; then
            echo "âŒ Rootfs not found at: $ROOTFS"
            ls -l "$(dirname "$ROOTFS")"
            exit 1
          fi
          echo "ğŸ“¦ Packing rootfs: $(basename "$ROOTFS")"

      - name: Run packing script
        working-directory: openwrt_packit
        run: |
          ROOTFS="${{ steps.set_rootfs.outputs.ROOTFS_PATH }}"
          # æ›¿æ¢ä¸ºä½ çš„å®é™…æ‰“åŒ…å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
          ./make_ext4fs -l 1024M -r "$ROOTFS" ../output.img

      - name: Upload packed image
        uses: actions/upload-artifact@v4
        with:
          name: packed-openwrt-image
          path: openwrt_packit/../output.img
