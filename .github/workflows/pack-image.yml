name: Pack ImmortalWrt with Custom Flippy Kernel

on:
  workflow_dispatch:
  workflow_call:

jobs:
  pack:
    runs-on: ubuntu-22.04
    steps:
      # --- 1. å®‰è£…ç³»ç»Ÿä¾èµ– ---
      - name: Install required system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            util-linux uuid-runtime parted dosfstools e2fsprogs btrfs-progs wget curl

          LSBLK_VER=$(lsblk --version | grep -oE '[0-9]+\.[0-9]+')
          if dpkg --compare-versions "$LSBLK_VER" lt "2.33"; then
            echo "âŒ lsblk version $LSBLK_VER is too old. Need >= 2.33."
            exit 1
          fi
          echo "âœ… System dependencies installed."

      # --- 2. è·å–å†…æ ¸ç‰ˆæœ¬å· ---
      - name: Fetch KERNEL_VERSION from whoami file
        id: get_version
        run: |
          VERSION=$(curl -s https://raw.githubusercontent.com/SaeTheOne/openwrt3/refs/heads/main/flippy_kernel/whoami | grep -oP 'KERNEL_VERSION=\K.*')
          if [ -z "$VERSION" ]; then
            echo "âŒ Failed to extract KERNEL_VERSION"
            exit 1
          fi
          echo "kernel_version=$VERSION" >> $GITHUB_OUTPUT

      # --- 3. ä¸‹è½½å†…æ ¸æ–‡ä»¶åˆ° /opt/kernel ---
      - name: Download kernel files to /opt/kernel
        run: |
          VERSION="${{ steps.get_version.outputs.kernel_version }}"
          BASE_URL="https://raw.githubusercontent.com/SaeTheOne/openwrt3/refs/heads/main/flippy_kernel"
          sudo mkdir -p /opt/kernel

          FILES=("Image" "modules.tar.gz" "s905d_s905x3_beikeyun.dtb")
          for FILE in "${FILES[@]}"; do
            echo "ğŸ“¥ Downloading $FILE"
            sudo curl -L -o "/opt/kernel/$FILE" "$BASE_URL/$FILE"
          done

          # åˆ›å»º dtb ç¬¦å·é“¾æ¥ï¼ˆä¾›è„šæœ¬ä½¿ç”¨ï¼‰
          sudo ln -sf /opt/kernel/s905d_s905x3_beikeyun.dtb /opt/kernel/dtb
          echo "âœ… Kernel ready in /opt/kernel"

      # --- 4. å…‹éš† openwrt_packit ---
      - name: Clone openwrt_packit
        run: |
          cd /opt
          sudo git clone https://github.com/unifreq/openwrt_packit
          echo "âœ… Cloned openwrt_packit"
          
      - name: Create dynamic whoami
        run: |
          WHOAMI="SaeTheOne"
          OPENWRT_VER="R$(date +%y.%m.%d)"
          DISTRIB_DESCRIPTION="ImmortalWrt"
          KERNEL_VERSION="${{ steps.get_version.outputs.kernel_version }}"
          
          echo "WHOAMI=$WHOAMI" > /opt/openwrt_packit/whoami
          echo "OPENWRT_VER=$OPENWRT_VER" >> /opt/openwrt_packit/whoami
          echo "DISTRIB_DESCRIPTION=$DISTRIB_DESCRIPTION" >> /opt/openwrt_packit/whoami
          echo "KERNEL_VERSION=$KERNEL_VERSION" >> /opt/openwrt_packit/whoami
          
          echo "âœ… Created whoami file:"
          cat /opt/openwrt_packit/whoami
          
      # --- 5. ä¸‹è½½å¹¶å¤„ç† rootfs ---
      - name: Download rootfs-generic artifact
        uses: actions/download-artifact@v4
        with:
          name: rootfs-generic
          path: /tmp/rootfs

      - name: Rename immortalwrt rootfs to OpenWrt format
        id: handle_rootfs
        run: |
          ROOTFS_FILE=$(find /tmp/rootfs -name "*-generic-rootfs.tar.gz" | head -n1)
          if [ -z "$ROOTFS_FILE" ]; then
            echo "âŒ No *-generic-rootfs.tar.gz found!"
            ls -la /tmp/rootfs/
            exit 1
          fi

          BASE_NAME=$(basename "$ROOTFS_FILE")
          echo "Original rootfs: $BASE_NAME"

          # å¤åˆ¶åˆ° openwrt_packit ç›®å½•ï¼Œå¹¶é‡å‘½åä¸ºæ ‡å‡†æ ¼å¼
          TARGET_ROOTFS="/opt/openwrt_packit/OpenWrt-armvirt-64-default-rootfs.tar.gz"
          sudo cp "$ROOTFS_FILE" "$TARGET_ROOTFS"
          echo "âœ… Copied and renamed to OpenWrt-armvirt-64-default-rootfs.tar.gz"

          # è®°å½•åŸå§‹å‰ç¼€ç”¨äºåç»­æ¢å¤
          if [[ "$BASE_NAME" == immortalwrt* ]]; then
            echo "is_immortalwrt=true" >> $GITHUB_OUTPUT
            echo "original_prefix=immortalwrt" >> $GITHUB_OUTPUT
          else
            echo "is_immortalwrt=false" >> $GITHUB_OUTPUT
          fi

      # --- 6. æ‰§è¡Œæ‰“åŒ…è„šæœ¬ ---
      - name: Run mk_s905d_n1.sh
        run: |
          cd /opt/openwrt_packit
          sudo chmod +x mk_s905d_n1.sh
          echo "ğŸš€ Building image..."
          sudo ./mk_s905d_n1.sh
          echo "âœ… Build completed."

      # --- 7. æ¢å¤ä¸º immortalwrt å‰ç¼€å¹¶ä¸Šä¼  ---
      - name: Rename output image back to immortalwrt prefix
        run: |
          OUTPUT_DIR="/opt/openwrt_packit/output"
          OPENWRT_IMG=$(find "$OUTPUT_DIR" -name "OpenWrt-*.img" | head -n1)
          if [ -z "$OPENWRT_IMG" ]; then
            echo "âŒ No OpenWrt-*.img found in output!"
            ls -la "$OUTPUT_DIR"
            exit 1
          fi

          # æ›¿æ¢å‰ç¼€
          IMMORTALWRT_IMG="${OPENWRT_IMG//OpenWrt/immortalwrt}"
          sudo mv "$OPENWRT_IMG" "$IMMORTALWRT_IMG"
          echo "âœ… Renamed to: $(basename "$IMMORTALWRT_IMG")"

      - name: Upload final immortalwrt image
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-packed-image
          path: /opt/openwrt_packit/output/immortalwrt-*.img
