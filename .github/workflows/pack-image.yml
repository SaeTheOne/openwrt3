name: Pack OpenWrt Image

on:
  workflow_call:

jobs:
  pack:
    runs-on: ubuntu-22.04
    steps:      
      - name: Install e2fsprogs and essential tools
        run: |
          echo "ğŸ”§ Updating package list..."
          sudo apt-get update || { echo "âŒ Failed to update package list"; exit 1; }

          echo "ğŸ“¦ Installing e2fsprogs and essential tools..."
          # å®‰è£… e2fsprogs (åŒ…å« mkfs.ext4) ä»¥åŠå…¶ä»–å¯èƒ½éœ€è¦çš„å·¥å…·
          sudo apt-get install -y \
            e2fsprogs util-linux parted dosfstools btrfs-progs wget python3 \
            losetup lsblk blkid uuidgen fdisk mkfs.vfat mkfs.btrfs \
            || { echo "âŒ Failed to install one or more packages"; exit 1; }

          echo "âœ… All system dependencies installed."

      - name: Verify mkfs.ext4 is available and functional
        run: |
          echo "ğŸ” Checking if 'mkfs.ext4' command exists..."

          # æ–¹æ³•1: ä½¿ç”¨ which
          if which mkfs.ext4 > /dev/null 2>&1; then
            echo "âœ… 'which mkfs.ext4' found it."
          else
            echo "âŒ 'which mkfs.ext4' did NOT find it."
            exit 1
          fi

          # æ–¹æ³•2: ä½¿ç”¨ command -v
          if command -v mkfs.ext4 > /dev/null 2>&1; then
            echo "âœ… 'command -v mkfs.ext4' found it."
          else
            echo "âŒ 'command -v mkfs.ext4' did NOT find it."
            exit 1
          fi

          # æ–¹æ³•3: ç›´æ¥è·å–è·¯å¾„
          MKFS_EXT4_PATH=$(which mkfs.ext4)
          echo "ğŸ“ Path of mkfs.ext4: $MKFS_EXT4_PATH"

          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "$MKFS_EXT4_PATH" ]; then
            echo "âœ… File '$MKFS_EXT4_PATH' exists."
          else
            echo "âŒ File '$MKFS_EXT4_PATH' does not exist!"
            exit 1
          fi

          # æ£€æŸ¥æ–‡ä»¶æƒé™å’Œç±»å‹
          echo "ğŸ“„ File details:"
          ls -l "$MKFS_EXT4_PATH"
          file "$MKFS_EXT4_PATH"

          # æµ‹è¯•æ‰§è¡Œå¸®åŠ©å‘½ä»¤
          echo "ğŸ§ª Testing 'mkfs.ext4 -h'..."
          if mkfs.ext4 -h > /dev/null 2>&1; then
            echo "âœ… 'mkfs.ext4 -h' executed successfully."
            echo "ğŸ“‹ Help output:"
            mkfs.ext4 -h | head -n 10 # åªæ˜¾ç¤ºå‰10è¡Œå¸®åŠ©ä¿¡æ¯
          else
            echo "âŒ 'mkfs.ext4 -h' failed to execute."
            exit 1
          fi

          echo "ğŸ‰ SUCCESS: mkfs.ext4 is installed, found, and executable!"

      - name: Clone openwrt_packit tool
        run: |
          git clone --depth=1 https://github.com/unifreq/openwrt_packit.git
          ls -la openwrt_packit/

      - name: Download pre-built rootfs artifact
        uses: actions/download-artifact@v4
        with:
          name: openwrt-rootfs-for-packing
        # This places 'rootfs.tar.gz' in the current directory

      - name: Verify rootfs exists
        run: |
          if [ ! -f "rootfs.tar.gz" ]; then
            echo "âŒ rootfs.tar.gz not found!"
            ls -l
            exit 1
          fi
          echo "âœ… Found rootfs.tar.gz ($(du -h rootfs.tar.gz))"

      - name: Run packing script
        working-directory: openwrt_packit
        run: |
          echo "ğŸ“¦ Packing image using pack.py..."
          # Ensure rootfs is accessible in the packit dir
          cp ../rootfs.tar.gz ./
          # Run pack.py (part of openwrt_packit)
          python3 pack.py -r rootfs.tar.gz -o ../immortalwrt-packed.img -s 1024M
          ls -lh ../immortalwrt-packed.img
          echo "âœ… Image packed successfully."

      - name: Upload packed image as artifact
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-packed-image
          path: immortalwrt-packed.img
