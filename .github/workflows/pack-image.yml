name: Pack OpenWrt Image

on:
  workflow_call:
  workflow_dispatch:

jobs:
  pack:
    runs-on: ubuntu-22.04
    steps:
      - name: Install all required system dependencies
        run: |
          echo "üîß Updating package list..."
          sudo apt-get update || { echo "‚ùå Failed to update package list"; exit 1; }
      
          echo "üì¶ Installing ALL necessary system tools..."
          sudo apt-get install -y \
            util-linux uuid-runtime parted dosfstools e2fsprogs btrfs-progs wget python3 \
            || { echo "‚ùå Failed to install one or more packages"; exit 1; }
      
          echo "‚úÖ All system dependencies installed."

      # Â¶ÇÊûú‰Ω†Â∑≤ÁªèÈÄöËøá actions/cache ÊàñÂÖ∂‰ªñÊñπÂºèÈ¢ÑÂÆâË£Ö‰∫Ü make_ext4fsÔºå
      # Ëøô‰∏ÄÊ≠•ÂèØ‰ª•ÁúÅÁï•„ÄÇ
      # ‰ΩÜ‰∏∫‰∫ÜÂÅ•Â£ÆÊÄßÔºåÂª∫ËÆÆËøòÊòØÊ£ÄÊü•‰∏Ä‰∏ãÊòØÂê¶Â≠òÂú®ÔºåÊàñËÄÖÁ°Æ‰øùÂÆÉÂú® PATH ‰∏≠„ÄÇ
      - name: Verify make_ext4fs is available
        run: |
          which make_ext4fs || { echo "‚ùå make_ext4fs not found in PATH"; exit 1; }
          make_ext4fs -h > /dev/null 2>&1 || { echo "‚ùå make_ext4fs is not executable or broken"; exit 1; }
          echo "‚úÖ make_ext4fs is ready."

      - name: Clone openwrt_packit tool
        run: |
          git clone --depth=1 https://github.com/unifreq/openwrt_packit.git
          ls -la openwrt_packit/

      - name: Download pre-built rootfs artifact
        uses: actions/download-artifact@v4
        with:
          name: openwrt-rootfs-for-packing
        # This places 'rootfs.tar.gz' in the current directory

      - name: Verify rootfs exists
        run: |
          if [ ! -f "rootfs.tar.gz" ]; then
            echo "‚ùå rootfs.tar.gz not found!"
            ls -l
            exit 1
          fi
          echo "‚úÖ Found rootfs.tar.gz ($(du -h rootfs.tar.gz))"

      - name: Run packing script
        working-directory: openwrt_packit
        run: |
          echo "üì¶ Packing image using pack.py..."
          # Ensure rootfs is accessible
          cp ../rootfs.tar.gz ./
          # Run pack.py (part of openwrt_packit)
          python3 pack.py -r rootfs.tar.gz -o ../immortalwrt-packed.img -s 1024M
          ls -lh ../immortalwrt-packed.img
          echo "‚úÖ Image packed successfully."

      - name: Upload packed image as artifact
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-packed-image
          path: immortalwrt-packed.img
