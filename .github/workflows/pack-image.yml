name: ğŸ“¦ Pack OpenWrt/ImmortalWrt Image

on:
  workflow_call:
    inputs:
      rootfs_url:
        description: 'è¿œç¨‹ rootfs ä¸‹è½½ URLï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string
      rootfs_path:
        description: 'æ„å»ºç”Ÿæˆçš„ rootfs è·¯å¾„ï¼ˆç”¨äºåŒä»“è°ƒç”¨æ—¶çš„æç¤ºï¼Œä»…ç”¨äºæ—¥å¿—ï¼‰'
        required: false
        type: string
      whoami_content:
        description: 'openwrt_packit çš„ whoami æ–‡ä»¶å†…å®¹ï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string
      kernel_base_url:
        description: 'å†…æ ¸ tarball åŸºç¡€ URLï¼ˆé»˜è®¤ä¸º SaeTheOne/openwrt3 flippy_kernelï¼‰'
        required: false
        type: string
  workflow_dispatch:
    inputs:
      rootfs_url:
        description: 'è¿œç¨‹ rootfs ä¸‹è½½ URLï¼ˆå¯é€‰ï¼‰'
        required: false
        default: ''
      whoami_content:
        description: 'openwrt_packit çš„ whoami æ–‡ä»¶å†…å®¹ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: ''
      kernel_base_url:
        description: 'å†…æ ¸ tarball åŸºç¡€ URLï¼ˆé»˜è®¤ä¸º SaeTheOne/openwrt3 flippy_kernelï¼‰'
        required: false
        default: 'https://raw.githubusercontent.com/SaeTheOne/openwrt3/main/flippy_kernel'

jobs:
  pack:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout openwrt_packit
        uses: actions/checkout@v4
        with:
          repository: unifreq/openwrt_packit
          path: ./openwrt_packit

      - name: Write whoami file
        run: |
          if [ -n "${{ inputs.whoami_content }}" ]; then
            CONTENT="${{ inputs.whoami_content }}"
            printf "%s\n" "$CONTENT" > ./openwrt_packit/whoami
          else
            # ä»è°ƒç”¨ä»“åº“é»˜è®¤åˆ†æ”¯æ‹‰å– whoamiï¼ˆå¦‚å¤±è´¥åˆ™ä¿æŒç©ºï¼‰
            REPO="${GITHUB_REPOSITORY}"
            BRANCH="main"
            URL="https://raw.githubusercontent.com/${REPO}/${BRANCH}/flippy_kernel/whoami"
            echo "å°è¯•è·å– whoami: $URL"
            curl -fsSL "$URL" -o ./openwrt_packit/whoami || true
          fi

          echo "å½“å‰ whoami å†…å®¹:"
          cat ./openwrt_packit/whoami || true

      - name: Prepare kernel files based on whoami
        env:
          KERNEL_BASE_URL: ${{ inputs.kernel_base_url }}
        run: |
          set -e
          KERNEL_VERSION=$(grep '^KERNEL_VERSION=' ./openwrt_packit/whoami | cut -d'=' -f2)
          if [ -z "$KERNEL_VERSION" ]; then
            echo "æœªåœ¨ whoami ä¸­æ‰¾åˆ° KERNEL_VERSION"
            exit 1
          fi
          BASE_URL=${KERNEL_BASE_URL:-https://raw.githubusercontent.com/SaeTheOne/openwrt3/main/flippy_kernel}
          echo "ä½¿ç”¨å†…æ ¸ç‰ˆæœ¬: $KERNEL_VERSION"
          echo "å†…æ ¸æ¥æº: $BASE_URL"
          sudo mkdir -p /opt/kernel
          cd /tmp
          for f in \
            "boot-$KERNEL_VERSION.tar.gz" \
            "dtb-allwinner-$KERNEL_VERSION.tar.gz" \
            "dtb-amlogic-$KERNEL_VERSION.tar.gz" \
            "dtb-rockchip-$KERNEL_VERSION.tar.gz" \
            "header-$KERNEL_VERSION.tar.gz" \
            "modules-$KERNEL_VERSION.tar.gz"; do
            echo "ä¸‹è½½: $BASE_URL/$f"
            curl -fsSL "$BASE_URL/$f" -o "$f"
            sudo cp "$f" /opt/kernel/
          done

      - name: Download rootfs from URL
        if: ${{ inputs.rootfs_url != '' }}
        run: |
          URL="${{ inputs.rootfs_url }}"
          echo "ğŸ“¥ ä» URL ä¸‹è½½ rootfs: $URL"
          # ä»URLä¸­æå–åŸå§‹æ–‡ä»¶åï¼Œä¿ç•™æ–‡ä»¶çš„åŸå§‹åç§°
          ORIGINAL_NAME=$(basename "$URL")
          curl -fsSL "$URL" -o "$ORIGINAL_NAME"
          echo "ROOTFS_FILE=$ORIGINAL_NAME" >> $GITHUB_ENV

      - name: Download rootfs artifact (fallback)
        if: ${{ inputs.rootfs_url == '' }}
        uses: actions/download-artifact@v4
        with:
          path: ./artifact_rootfs
          pattern: "*.tar.gz"
          merge-multiple: true

      - name: Prepare rootfs from artifact
        if: ${{ inputs.rootfs_url == '' }}
        run: |
          set -e
          FILE=$(find ./artifact_rootfs -type f -name "*.tar.gz" | head -n1)
          if [ -z "$FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ° rootfs artifact (*.tar.gz)"
            exit 1
          fi
          # ä¿ç•™åŸå§‹æ–‡ä»¶åï¼Œä¸è¿›è¡Œé‡å‘½å
          ORIGINAL_NAME=$(basename "$FILE")
          cp "$FILE" "$ORIGINAL_NAME"
          echo "ROOTFS_FILE=$ORIGINAL_NAME" >> $GITHUB_ENV

      - name: Mirror rootfs into tmp directory (compat)
        run: |
          mkdir -p tmp
          cp -f "${{ env.ROOTFS_FILE }}" tmp/

      - name: Record rootfs metadata
        run: |
          if [ -n "${{ inputs.rootfs_url }}" ]; then
            ORIGINAL_NAME=$(basename "${{ inputs.rootfs_url }}")
          else
            ORIGINAL_NAME=$(basename $(find ./artifact_rootfs -type f -name "*.tar.gz" | head -n1))
          fi
          KERNEL_VERSION=$(grep '^KERNEL_VERSION=' ./openwrt_packit/whoami | cut -d'=' -f2)
          {
            echo "original_rootfs_name=$ORIGINAL_NAME";
            echo "kernel_version=$KERNEL_VERSION";
            echo "whoami:";
            cat ./openwrt_packit/whoami;
          } > rootfs-meta.txt
          BASE=${ORIGINAL_NAME%.tar.gz}
          BASE=${BASE%-generic-rootfs}
          BASE=${BASE%-rootfs}
          echo "PACKED_ARTIFACT_NAME=${BASE}-packed-image" >> $GITHUB_ENV

      - name: Upload rootfs metadata
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-rootfs-for-packing-meta
          path: rootfs-meta.txt

      - name: Run packing script
        working-directory: ./openwrt_packit
        run: |
          ROOTFS_FILE="${{ env.ROOTFS_FILE }}"
          echo "ğŸ“¦ Packing image using: ../$ROOTFS_FILE"
          # ç¡®ä¿ä¸´æ—¶ç›®å½•ä¸å­˜åœ¨
          sudo rm -rf tmp/* 2>/dev/null || true
          mkdir -p tmp
          # å¤åˆ¶rootfsåˆ°openwrt_packitçš„tmpç›®å½•ï¼Œä¿æŒåŸå§‹åç§°
          cp -f ../$ROOTFS_FILE tmp/
          # å¯¹äºopenwrt_packitè„šæœ¬ï¼Œå¯èƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªè½¯é“¾æ¥åˆ°é¢„æœŸçš„æ–‡ä»¶å
          cd tmp
          # è·å–rootfsæ–‡ä»¶çš„åŸºæœ¬åç§°ï¼ˆä¸å«è·¯å¾„ï¼‰
          BASENAME=$(basename "$ROOTFS_FILE")
          # åˆ›å»ºä¸€ä¸ªè½¯é“¾æ¥ï¼ŒæŒ‡å‘æˆ‘ä»¬çš„rootfsæ–‡ä»¶ï¼Œä½†ä½¿ç”¨è„šæœ¬å¯èƒ½æœŸæœ›çš„æ ¼å¼
          ln -sf "$BASENAME" "openwrt-armvirt-64-default-rootfs.tar.gz" || true
          cd ..
          # ä¿®æ”¹mk_s905d_n1.shè„šæœ¬ï¼Œç¡®ä¿mkdirå‘½ä»¤ä½¿ç”¨-på‚æ•°
          sed -i 's/mkdir /mkdir -p /g' ./mk_s905d_n1.sh
          # è¿è¡Œæ‰“åŒ…è„šæœ¬
          sudo ./mk_s905d_n1.sh _test


      - name: Upload packed image(s)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKED_ARTIFACT_NAME }}
          path: ./openwrt_packit/output/*.img
          if-no-files-found: error
