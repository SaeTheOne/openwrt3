name: Pack OpenWrt Image

on:
  workflow_call:

jobs:
  pack:
    runs-on: ubuntu-22.04
    steps:
      # --- å…‹éš†ä½ çš„ä»“åº“ ---
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- å®‰è£…ç³»ç»Ÿä¾èµ– ---
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            util-linux uuid-runtime parted dosfstools e2fsprogs btrfs-progs wget

      # --- æ£€æŸ¥ä½ çš„ flippy_kernel ç›®å½• ---
      - name: Verify flippy_kernel directory
        run: |
          if [ ! -d "flippy_kernel" ]; then
            echo "âŒ flippy_kernel directory not found!"
            ls -la
            exit 1
          fi
          echo "âœ… flippy_kernel directory found."
          ls -la flippy_kernel/

      # --- åˆ›å»ºç¬¦åˆ Action é¢„æœŸçš„å†…æ ¸åŒ… ---
      # Action ä¼šå°è¯•ä¸‹è½½ kernel-6.12.46.tar.gz
      # æˆ‘ä»¬æå‰åˆ›å»ºå®ƒï¼Œè¿™æ · wget -c å°±ä¸ä¼šå»ä¸‹è½½
      - name: Create kernel package for openwrt_packit
        run: |
          echo "ğŸ“¦ Creating kernel package: kernel-6.12.46.tar.gz"
          cd flippy_kernel
          # æ‰“åŒ… Image, dtb, modules.tar.gz
          # æ³¨æ„ï¼šå¦‚æœ modules.tar.gz ä¸å­˜åœ¨ï¼Œä½ éœ€è¦å…ˆåˆ›å»ºå®ƒ
          tar -czf ../kernel-6.12.46.tar.gz Image dtb modules.tar.gz
          cd ..
          ls -lh kernel-6.12.46.tar.gz
          echo "âœ… Created kernel-6.12.46.tar.gz"

      # --- ç¡®ä¿ rootfs.tar.gz å­˜åœ¨ ---
      - name: Verify rootfs
        run: |
          if [ ! -f "rootfs.tar.gz" ]; then
            echo "âŒ rootfs.tar.gz not found!"
            exit 1
          fi
          echo "âœ… Found rootfs.tar.gz"

      # --- è°ƒç”¨ openwrt_packit Action ---
      # å…³é”®ï¼šè®¾ç½® KERNEL_VERSION_NAME ä¸º 6.12.46
      # Action ä¼šå°è¯•ä¸‹è½½ kernel-6.12.46.tar.gz
      # ä½†æˆ‘ä»¬å·²ç»åˆ›å»ºäº†å®ƒï¼Œæ‰€ä»¥ wget -c ä¼šç›´æ¥ä½¿ç”¨æœ¬åœ°æ–‡ä»¶
      - name: Package Armvirt as OpenWrt
        uses: unifreq/openwrt_packit@master
        env:
          OPENWRT_ARMVIRT: openwrt/bin/targets/*/*/*.tar.gz
          PACKAGE_SOC: s905d
          KERNEL_VERSION_NAME: 6.12.46 # ğŸ‘ˆ Action ä¼šç”¨è¿™ä¸ªå€¼æ„é€  URL

      # --- ä¸Šä¼ æœ€ç»ˆçš„æ‰“åŒ…é•œåƒ ---
      - name: Upload packed image as artifact
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-packed-image
          path: immortalwrt-packed.img
