name: Pack OpenWrt Image

on:
  workflow_call:

jobs:
  pack:
    runs-on: ubuntu-22.04
    steps:
      # --- å®‰è£…ç³»ç»Ÿä¾èµ– ---
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            util-linux uuid-runtime parted dosfstools e2fsprogs btrfs-progs wget

      # --- åˆ›å»º /opt/kernel ç›®å½•å¹¶å¤åˆ¶ä½ çš„å†…æ ¸æ–‡ä»¶ ---
      - name: Setup Flippy kernel directory
        run: |
          # åˆ›å»ºç›®å½•
          sudo mkdir -p /opt/kernel
          
          # æ£€æŸ¥ flippy_kernel ç›®å½•
          if [ ! -d "flippy_kernel" ]; then
            echo "âŒ flippy_kernel directory not found!"
            exit 1
          fi

          # å¤åˆ¶å†…æ ¸æ–‡ä»¶ï¼Œå¹¶é‡å‘½åä¸ºé€šç”¨åç§°
          # mk_xxx.sh è„šæœ¬æœŸæœ› /opt/kernel ä¸‹æœ‰ Image, dtb, modules.tar.gz
          sudo cp flippy_kernel/Image /opt/kernel/
          sudo cp flippy_kernel/modules.tar.gz /opt/kernel/
          # ğŸ‘‡ å…³é”®ï¼šå°† s905d_s905x3_beikeyun.dtb é‡å‘½åä¸º dtb
          sudo cp flippy_kernel/s905d_s905x3_beikeyun.dtb /opt/kernel/dtb

          # è®¾ç½®æƒé™
          sudo chmod 644 /opt/kernel/*

          # éªŒè¯
          echo "âœ… /opt/kernel directory contents:"
          ls -la /opt/kernel/

      # --- ç¡®ä¿ rootfs.tar.gz å­˜åœ¨ ---
      - name: Verify rootfs
        run: |
          if [ ! -f "rootfs.tar.gz" ]; then
            echo "âŒ rootfs.tar.gz not found!"
            exit 1
          fi
          sudo cp rootfs.tar.gz /opt/openwrt_packit/
          echo "âœ… rootfs.tar.gz copied to /opt/openwrt_packit/"

      # --- è°ƒç”¨ openwrt_packit Action ---
      # è¿™ä¸ª Action ä¼šæ¨¡æ‹Ÿè¿è¡Œ mk_xxx.sh è„šæœ¬
      # å®ƒä¼šä» /opt/kernel è¯»å–å†…æ ¸ï¼Œä» /opt/openwrt_packit è¯»å– rootfs
      - name: Package Armvirt as OpenWrt
        uses: unifreq/openwrt_packit@master
        env:
          OPENWRT_ARMVIRT: openwrt/bin/targets/*/*/*.tar.gz
          PACKAGE_SOC: s905d
          # æ³¨æ„ï¼šè¿™é‡Œ KERNEL_VERSION_NAME å¯èƒ½ä¸å†éœ€è¦
          # å› ä¸º Action ä¼šç›´æ¥ä» /opt/kernel è¯»å–æ–‡ä»¶
          # å¦‚æœ Action ä»ç„¶å°è¯•ä¸‹è½½ï¼Œä½ å¯èƒ½éœ€è¦è®¾ç½®ä¸€ä¸ªè™šæ‹Ÿå€¼
          # KERNEL_VERSION_NAME: dummy

      # --- ä¸Šä¼ ç»“æœ ---
      - name: Upload packed image
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-packed-image
          path: /opt/openwrt_packit/output/*.img
