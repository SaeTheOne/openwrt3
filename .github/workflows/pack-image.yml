name: Pack OpenWrt Image

on:
  workflow_call:

jobs:
  pack:
    runs-on: ubuntu-22.04
    steps:
      - name: Install system dependencies for openwrt_packit
        run: |
          echo "üîß Installing required tools..."
          sudo apt-get update
          sudo apt-get install -y \
              uuid-runtime \     # provides uuidgen
              parted \           # provides parted
              dosfstools \       # provides mkfs.vfat
              btrfs-progs        # provides mkfs.btrfs
          echo "‚úÖ All dependencies installed."

      - name: Install dependencies and make_ext4fs
        run: |
          echo "üì• Installing dependencies..."
          sudo apt-get update
          sudo apt-get install -y python3 e2fsprogs wget

          echo "üì• Downloading make_ext4fs..."
          wget https://github.com/sae/sd-fuse_rk3328/raw/master/tools/make_ext4fs -O make_ext4fs
          chmod +x make_ext4fs
          sudo mv make_ext4fs /usr/local/bin/
          make_ext4fs -h  # Verify it works

      - name: Clone openwrt_packit tool
        run: git clone --depth=1 https://github.com/unifreq/openwrt_packit.git

      - name: Download pre-built rootfs artifact
        uses: actions/download-artifact@v4
        with:
          name: openwrt-rootfs-for-packing
        # This will place 'rootfs.tar.gz' in the current directory

      - name: Verify rootfs exists
        run: |
          if [ ! -f "rootfs.tar.gz" ]; then
            echo "‚ùå rootfs.tar.gz not found!"
            ls -l
            exit 1
          fi
          echo "‚úÖ Found rootfs.tar.gz"

      - name: Run packing script
        working-directory: openwrt_packit
        run: |
          echo "üì¶ Packing image..."
          python3 pack.py -r ../rootfs.tar.gz -o ../immortalwrt-packed.img -s 1024M
          ls -lh ../immortalwrt-packed.img

      - name: Upload packed image as artifact
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-packed-image
          path: immortalwrt-packed.img
