name: Pack OpenWrt Image

on:
  workflow_call:

jobs:
  pack:
    runs-on: ubuntu-22.04
    steps:
      - name: Install all required system dependencies
        run: |
          echo "üîß Updating package list..."
          sudo apt-get update || { echo "‚ùå Failed to update package list"; exit 1; }

          echo "üì¶ Installing ALL necessary system tools..."
          sudo apt-get install -y \
            util-linux uuid-runtime parted dosfstools e2fsprogs btrfs-progs wget python3 \
            || { echo "‚ùå Failed to install one or more packages"; exit 1; }

          echo "‚úÖ All system dependencies installed."

      - name: Download and install make_ext4fs
        run: |
          echo "üì• Downloading make_ext4fs from verified source..."
          # Using a known good link
          wget https://github.com/ophub/amlogic-s9xxx-openwrt/raw/main/common-files/tools/make_ext4fs -O make_ext4fs
          echo "‚úÖ Downloaded make_ext4fs locally."

          echo "üîç Checking file type..."
          file make_ext4fs

          echo "üîß Making executable..."
          chmod +x make_ext4fs
          echo "‚úÖ Made executable."

          echo "üöö Moving to /usr/local/bin/..."
          sudo mv make_ext4fs /usr/local/bin/
          echo "‚úÖ Moved to /usr/local/bin/"

          echo "üîç Verifying file exists at destination..."
          ls -l /usr/local/bin/make_ext4fs

          echo "üîç Checking PATH..."
          echo "PATH is: $PATH"

          echo "üîç Trying 'command -v' to find make_ext4fs..."
          if command -v make_ext4fs > /dev/null 2>&1; then
            echo "‚úÖ make_ext4fs found via command -v"
            make_ext4fs -h > /dev/null 2>&1 && echo "‚úÖ make_ext4fs is executable"
          else
            echo "‚ùå make_ext4fs NOT found via command -v"
            echo "PATH is: $PATH"
            ls -l /usr/local/bin/make_ext4fs 2>/dev/null || echo "/usr/local/bin/make_ext4fs does not exist"
            exit 1
          fi

          echo "‚úÖ make_ext4fs is ready and functional."

      - name: Clone openwrt_packit tool
        run: |
          git clone --depth=1 https://github.com/unifreq/openwrt_packit.git
          ls -la openwrt_packit/

      - name: Download pre-built rootfs artifact
        uses: actions/download-artifact@v4
        with:
          name: openwrt-rootfs-for-packing
        # This places 'rootfs.tar.gz' in the current directory

      - name: Verify rootfs exists
        run: |
          if [ ! -f "rootfs.tar.gz" ]; then
            echo "‚ùå rootfs.tar.gz not found!"
            ls -l
            exit 1
          fi
          echo "‚úÖ Found rootfs.tar.gz ($(du -h rootfs.tar.gz))"

      - name: Run packing script
        working-directory: openwrt_packit
        run: |
          echo "üì¶ Packing image using pack.py..."
          # Ensure rootfs is accessible in the packit dir
          cp ../rootfs.tar.gz ./
          # Run pack.py (part of openwrt_packit)
          python3 pack.py -r rootfs.tar.gz -o ../immortalwrt-packed.img -s 1024M
          ls -lh ../immortalwrt-packed.img
          echo "‚úÖ Image packed successfully."

      - name: Upload packed image as artifact
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-packed-image
          path: immortalwrt-packed.img
