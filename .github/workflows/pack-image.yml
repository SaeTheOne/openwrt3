name: Pack OpenWrt Image

on:
  workflow_call:

jobs:
  pack:
    runs-on: ubuntu-22.04
    steps:      
      - name: Install e2fsprogs and essential tools
        run: |
          echo "üîß Updating package list..."
          sudo apt-get update || { echo "‚ùå Failed to update package list"; exit 1; }

          echo "üì¶ Installing essential system packages..."
          # Âè™ÂÆâË£ÖÁúüÊ≠£ÁöÑËΩØ‰ª∂ÂåÖÔºåÂÆÉ‰ª¨ÂåÖÂê´‰∫ÜÊâÄÈúÄÁöÑÂ∑•ÂÖ∑
          sudo apt-get install -y \
            e2fsprogs \
            util-linux \
            parted \
            dosfstools \
            btrfs-progs \
            wget \
            python3 \
            || { echo "‚ùå Failed to install one or more packages"; exit 1; }

          echo "‚úÖ All system packages installed."

      - name: Verify essential tools are available
        run: |
          echo "üîç Verifying essential tools are available:"
          # Ê£ÄÊü•Ëøô‰∫õÂëΩ‰ª§ÊòØÂê¶ÂèØ‰ª•ÈÄöËøá PATH ÊâæÂà∞
          TOOLS_TO_CHECK="losetup lsblk blkid uuidgen fdisk parted mkfs.vfat mkfs.ext4 mkfs.btrfs"
          for tool in $TOOLS_TO_CHECK; do
            if command -v "$tool" > /dev/null 2>&1; then
              echo "‚úÖ $tool found at $(command -v "$tool")"
            else
              echo "‚ùå $tool NOT found!"
              exit 1
            fi
          done

          echo "üéâ SUCCESS: All essential tools are installed and available!"

      - name: Clone openwrt_packit tool
        run: |
          git clone --depth=1 https://github.com/unifreq/openwrt_packit.git
          ls -la openwrt_packit/

      - name: Download pre-built rootfs artifact
        uses: actions/download-artifact@v4
        with:
          name: openwrt-rootfs-for-packing

      - name: Verify rootfs exists
        run: |
          if [ ! -f "rootfs.tar.gz" ]; then
            echo "‚ùå rootfs.tar.gz not found!"
            ls -l
            exit 1
          fi
          echo "‚úÖ Found rootfs.tar.gz ($(du -h rootfs.tar.gz))"

      - name: Run packing script
        working-directory: openwrt_packit
        run: |
          echo "üì¶ Packing image using pack.py..."
          cp ../rootfs.tar.gz ./
          python3 pack.py -r rootfs.tar.gz -o ../immortalwrt-packed.img -s 1024M
          ls -lh ../immortalwrt-packed.img
          echo "‚úÖ Image packed successfully."

      - name: Upload packed image as artifact
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-packed-image
          path: immortalwrt-packed.img
