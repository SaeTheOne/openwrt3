name: ðŸ“¦ Pack OpenWrt/ImmortalWrt Image

on:
  workflow_call:
    inputs:
      rootfs_url:
        description: 'è¿œç¨‹ rootfs ä¸‹è½½ URLï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string
      rootfs_path:
        description: 'æž„å»ºç”Ÿæˆçš„ rootfs è·¯å¾„ï¼ˆç”¨äºŽåŒä»“è°ƒç”¨æ—¶çš„æç¤ºï¼Œä»…ç”¨äºŽæ—¥å¿—ï¼‰'
        required: false
        type: string
      whoami_content:
        description: 'openwrt_packit çš„ whoami æ–‡ä»¶å†…å®¹ï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string
      kernel_base_url:
        description: 'å†…æ ¸ tarball åŸºç¡€ URLï¼ˆé»˜è®¤ä¸º SaeTheOne/openwrt3 flippy_kernelï¼‰'
        required: false
        type: string
  workflow_dispatch:
    inputs:
      rootfs_url:
        description: 'è¿œç¨‹ rootfs ä¸‹è½½ URLï¼ˆå¯é€‰ï¼‰'
        required: false
        default: ''
      whoami_content:
        description: 'openwrt_packit çš„ whoami æ–‡ä»¶å†…å®¹ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: ''
      kernel_base_url:
        description: 'å†…æ ¸ tarball åŸºç¡€ URLï¼ˆé»˜è®¤ä¸º SaeTheOne/openwrt3 flippy_kernelï¼‰'
        required: false
        default: 'https://raw.githubusercontent.com/SaeTheOne/openwrt3/main/flippy_kernel'

jobs:
  pack:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout openwrt_packit
        uses: actions/checkout@v4
        with:
          repository: unifreq/openwrt_packit
          path: .

      - name: Write whoami file
        run: |
          if [ -n "${{ inputs.whoami_content }}" ]; then
            CONTENT="${{ inputs.whoami_content }}"
            printf "%s\n" "$CONTENT" > whoami
          else
            # ä»Žè°ƒç”¨ä»“åº“é»˜è®¤åˆ†æ”¯æ‹‰å– whoamiï¼ˆå¦‚å¤±è´¥åˆ™ä¿æŒç©ºï¼‰
            REPO="${GITHUB_REPOSITORY}"
            BRANCH="main"
            URL="https://raw.githubusercontent.com/${REPO}/${BRANCH}/flippy_kernel/whoami"
            echo "å°è¯•èŽ·å– whoami: $URL"
            curl -fsSL "$URL" -o whoami || true
          fi

          echo "å½“å‰ whoami å†…å®¹:"
          cat whoami || true

      - name: Prepare kernel files based on whoami
        run: |
          set -e
          KERNEL_VERSION=$(grep '^KERNEL_VERSION=' whoami | cut -d'=' -f2)
          if [ -z "$KERNEL_VERSION" ]; then
            echo "æœªåœ¨ whoami ä¸­æ‰¾åˆ° KERNEL_VERSION"
            exit 1
          fi
          BASE_URL="${{ inputs.kernel_base_url }}"
          [ -z "$BASE_URL" ] && BASE_URL="https://raw.githubusercontent.com/SaeTheOne/openwrt3/main/flippy_kernel"
          echo "ä½¿ç”¨å†…æ ¸ç‰ˆæœ¬: $KERNEL_VERSION"
          echo "å†…æ ¸æ¥æº: $BASE_URL"
          sudo mkdir -p /opt/kernel
          cd /tmp
          for f in \
            "boot-$KERNEL_VERSION.tar.gz" \
            "dtb-allwinner-$KERNEL_VERSION.tar.gz" \
            "dtb-amlogic-$KERNEL_VERSION.tar.gz" \
            "dtb-rockchip-$KERNEL_VERSION.tar.gz" \
            "header-$KERNEL_VERSION.tar.gz" \
            "modules-$KERNEL_VERSION.tar.gz"; do
            echo "ä¸‹è½½: $BASE_URL/$f"
            curl -fsSL "$BASE_URL/$f" -o "$f"
            sudo cp "$f" /opt/kernel/
          done

      - name: Download rootfs from URL
        if: ${{ inputs.rootfs_url != '' }}
        run: |
          URL="${{ inputs.rootfs_url }}"
          echo "ðŸ“¥ ä»Ž URL ä¸‹è½½ rootfs: $URL"
          curl -fsSL "$URL" -o openwrt-armvirt-64-default-rootfs.tar.gz
          echo "ROOTFS_FILE=openwrt-armvirt-64-default-rootfs.tar.gz" >> $GITHUB_ENV

      - name: Download rootfs artifact (fallback)
        if: ${{ inputs.rootfs_url == '' }}
        uses: actions/download-artifact@v4
        with:
          name: openwrt-rootfs-for-packing
          path: ./artifact_rootfs

      - name: Prepare rootfs from artifact
        if: ${{ inputs.rootfs_url == '' }}
        run: |
          set -e
          FILE=$(ls -1 ./artifact_rootfs/*.tar.gz | head -n1)
          if [ -z "$FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ° rootfs artifact (*.tar.gz)"
            exit 1
          fi
          cp "$FILE" openwrt-armvirt-64-default-rootfs.tar.gz
          echo "ROOTFS_FILE=openwrt-armvirt-64-default-rootfs.tar.gz" >> $GITHUB_ENV

      - name: Mirror rootfs into tmp directory (compat)
        run: |
          mkdir -p tmp
          cp -f openwrt-armvirt-64-default-rootfs.tar.gz tmp/

      - name: Run packing script
        run: |
          ROOTFS_FILE="${{ env.ROOTFS_FILE }}"
          echo "ðŸ“¦ Packing image using: $ROOTFS_FILE"
          if [ ! -f "./openwrt-armvirt-64-default-rootfs.tar.gz" ]; then sudo cp "$ROOTFS_FILE" ./openwrt-armvirt-64-default-rootfs.tar.gz; fi
          sudo ./mk_s905d_n1.sh _test

      - name: Upload packed image(s)
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-packed-image
          path: output/*.img
          if-no-files-found: error
