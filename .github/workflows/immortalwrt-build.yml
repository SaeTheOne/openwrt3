name: ImmortalWRT Build (适配仓库实际文件)

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master
  # 关键：使用你仓库中实际的配置文件名
  CONFIG_FILE: immortalwrt.config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_FIRMWARE: true
  TZ: Asia/Shanghai
  ALL_THREADS: 2
  DOCKER_IMAGE: ubuntu:22.04
  SOURCE_DIR: ./  # 你的文件在根目录

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库代码（包含你的配置文件）
        uses: actions/checkout@main

      - name: 1. 确认仓库文件存在
        run: |
          echo "=== 仓库根目录文件列表（确认你的配置文件） ==="
          ls -la $SOURCE_DIR/
          # 验证关键文件是否存在
          if [ ! -f "$SOURCE_DIR/$CONFIG_FILE" ]; then
            echo "❌ 未找到 $CONFIG_FILE，请检查仓库" && exit 1
          else
            echo "✅ 找到 $CONFIG_FILE"
          fi
          if [ ! -f "$SOURCE_DIR/$DIY_P1_SH" ]; then
            echo "❌ 未找到 $DIY_P1_SH，请检查仓库" && exit 1
          else
            echo "✅ 找到 $DIY_P1_SH"
          fi

      - name: 2. 准备编译目录
        run: |
          sudo mkdir -p /mnt/openwrt-build
          sudo chown -R runner:runner /mnt/openwrt-build
          # 复制仓库中的实际文件（使用你的 immortalwrt.config）
          cp $SOURCE_DIR/$CONFIG_FILE /mnt/openwrt-build/
          cp $SOURCE_DIR/$DIY_P1_SH /mnt/openwrt-build/ && chmod +x /mnt/openwrt-build/$DIY_P1_SH
          cp $SOURCE_DIR/$DIY_P2_SH /mnt/openwrt-build/ && chmod +x /mnt/openwrt-build/$DIY_P2_SH
          # 确认复制结果
          echo "=== /mnt/openwrt-build 目录文件 ==="
          ls -la /mnt/openwrt-build/

      - name: 3. 启动 Docker 容器
        run: |
          docker pull $DOCKER_IMAGE
          docker run -d \
            --name openwrt-builder \
            --volume /mnt/openwrt-build:/build \
            --env TZ=$TZ \
            --env ALL_THREADS=$ALL_THREADS \
            $DOCKER_IMAGE sleep infinity
          docker ps | grep -q "openwrt-builder" || { echo "❌ 容器启动失败"; exit 1; }

      - name: 4. 安装依赖（含 swig）
        run: |
          docker exec openwrt-builder bash -c "
            apt-get update && \
            DEBIAN_FRONTEND=noninteractive apt-get install -y tzdata && \
            apt-get install -y build-essential flex bison g++ gawk gcc swig git \
              libncurses5-dev libssl-dev zlib1g-dev python3 python3-pip rsync unzip wget && \
            apt-get clean
          " || { echo "❌ 依赖安装失败"; exit 1; }

      - name: 5. 克隆源码并编译
        run: |
          docker exec openwrt-builder bash -c "
            cd /build && \
            git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt && cd openwrt && \
            # 使用你的 immortalwrt.config 作为配置文件
            mv /build/$CONFIG_FILE .config && \
            # 执行自定义脚本
            /build/$DIY_P1_SH && \
            ./scripts/feeds update -a && ./scripts/feeds install -a && \
            /build/$DIY_P2_SH && \
            # 编译
            make defconfig && make download -j$ALL_THREADS && \
            make -j$ALL_THREADS || make -j1 V=s && \
            # 复制固件
            mkdir -p /build/firmware && cp bin/targets/*/*/*.tar.gz /build/firmware/
          " || { echo "❌ 编译失败"; exit 1; }

      - name: 6. 上传固件
        uses: actions/upload-artifact@main
        with:
          name: ImmortalWRT-Firmware
          path: /mnt/openwrt-build/firmware/*
          retention-days: 7

      - name: 7. 清理环境
        if: always()
        run: |
          docker stop openwrt-builder && docker rm openwrt-builder
          sudo rm -rf /mnt/openwrt-build
