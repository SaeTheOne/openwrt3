name: ImmortalWRT Build

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_COWTRANSFER: false
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: false
  TZ: Asia/Shanghai
  ALL_THREADS: 2

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
      - name: 检查磁盘初始空间
        run: |
          echo "=== 初始磁盘空间状态 ==="
          df -h
          echo "========================"
          df -h /mnt

      - name: 初始化环境（修复依赖冲突+稳定安装）
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          # 1. 强制修复包依赖（核心解决 broken packages 问题）
          sudo apt-get -qq update --fix-missing
          sudo apt-get -qq install -f -y  # 自动修复依赖冲突
          sudo dpkg --configure -a        # 修复未配置的包
          
          # 2. 写入稳定官方源（避免第三方源干扰）
          sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak
          cat << EOF | sudo tee /etc/apt/sources.list
          deb http://archive.ubuntu.com/ubuntu/ jammy main restricted universe multiverse
          deb http://archive.ubuntu.com/ubuntu/ jammy-updates main restricted universe multiverse
          deb http://archive.ubuntu.com/ubuntu/ jammy-backports main restricted universe multiverse
          deb http://security.ubuntu.com/ubuntu/ jammy-security main restricted universe multiverse
          EOF
          
          # 3. 再次更新源并清理冗余
          sudo apt-get -qq update
          sudo docker image prune --all --force
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo rm -rf /var/cache/apt/archives/*
          
          # 4. 分阶段安装依赖（先装基础库，再装工具，减少冲突）
          # 第一阶段：安装基础依赖库
          sudo apt-get -qq install -y libncurses5-dev libssl-dev zlib1g-dev
          # 第二阶段：安装编译工具链
          sudo apt-get -qq install -y build-essential flex bison g++ gawk gcc
          # 第三阶段：安装辅助工具
          sudo apt-get -qq install -y git python3 python3-pip python3-setuptools python3-apt
          sudo apt-get -qq install -y rsync unzip file wget
          
          # 5. 验证核心工具是否正常
          echo "=== 工具验证 ==="
          command -v gcc && echo "gcc 正常" || echo "gcc 异常"
          command -v make && echo "make 正常" || echo "make 异常"
          command -v python3 && echo "python3 正常" || echo "python3 异常"
          
          # 6. 最终清理
          sudo apt-get -qq autoremove --purge
          sudo apt-get -qq clean
          echo "=== 清理后根分区空间 ==="
          df -h /

      - name: 准备大空间工作目录（/mnt）
        run: |
          sudo mkdir -p /mnt/workdir
          sudo chown -R runner:runner /mnt/workdir
          echo "=== /mnt/workdir 目录信息 ==="
          ls -ld /mnt/workdir
          echo "=== /mnt/workdir 所在分区空间 ==="
          df -hT /mnt/workdir

      - name: 克隆源码
        working-directory: /mnt/workdir
        run: |
          echo "=== 当前克隆目录 ==="
          echo $PWD
          df -hT $PWD
          # 克隆时增加超时重试，避免网络问题
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt || git clone $REPO_URL -b $REPO_BRANCH openwrt
          cd openwrt && git pull
          # 创建软链接并验证
          ln -sf /mnt/workdir/openwrt $GITHUB_WORKSPACE/openwrt
          echo "=== 软链接验证 ==="
          ls -l $GITHUB_WORKSPACE/openwrt
          echo "=== 源码目录大小 ==="
          du -sh /mnt/workdir/openwrt

      - name: 加载自定义配置
        run: |
          [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
          [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
          chmod +x $DIY_P1_SH $DIY_P2_SH
          cd openwrt && ../$DIY_P1_SH

      - name: 更新 feeds（增加重试）
        run: |
          cd openwrt
          ./scripts/feeds update -a || ./scripts/feeds update -a  # 重试一次
          ./scripts/feeds install -a || ./scripts/feeds install -a

      - name: 应用自定义脚本
        run: |
          cd openwrt && ../$DIY_P2_SH

      - name: 下载软件包（优化缓存）
        id: package
        run: |
          cd openwrt
          make defconfig
          # 分线程下载，避免超时
          make download -j$ALL_THREADS || make download -j1
          # 清理无效小包
          find dl -size -1024c -exec rm -f {} \;
          echo "=== 下载包目录大小 ==="
          du -sh dl
          echo "=== 下载包后 /mnt 空间 ==="
          df -h /mnt

      - name: 多线程编译（容错处理）
        run: |
          cd openwrt
          echo "=== 开始编译，当前线程数：$ALL_THREADS ==="
          # 先多线程，失败则单线程，再失败则 verbose 模式排错
          make -j$ALL_THREADS || make -j1 || make -j1 V=s
          echo "=== 编译后 /mnt 空间 ==="
          df -h /mnt

      - name: 整理输出文件
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
        run: |
          cd openwrt/bin/targets/*/*
          rm -rf packages  # 移除冗余包目录
          echo "FIRMWARE_DIR=$PWD" >> $GITHUB_ENV
          echo "::set-output name=status::success"
          echo "=== 输出文件列表及大小 ==="
          ls -lh

      - name: 上传固件到工件
        uses: actions/upload-artifact@main
        if: steps.organize.outputs.status == 'success' && !cancelled()
        with:
          name: ImmortalWRT-Firmware
          path: ${{ env.FIRMWARE_DIR }}
          retention-days: 7  # 保留7天，避免占用空间

      - name: 上传固件到 Release
        uses: softprops/action-gh-release@master
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: ${{ env.FIRMWARE_DIR }}/*
          name: Build ${{ env.REPO_BRANCH }} @ ${{ github.sha }}
          body: |
            ## 自动构建固件
            - 源码分支：${{ env.REPO_BRANCH }}
            - 源码 Commit：${{ github.sha }}
            - 构建时间：${{ env.BUILD_DATE }}
          draft: false
          prerelease: false

      - name: 清理编译目录
        if: always()
        run: |
          cd openwrt && make clean
          echo "=== 清理后 /mnt 空间 ==="
          df -h /mnt
