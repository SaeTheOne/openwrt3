name: ImmortalWRT Build (ä¿®å¤ root ç¼–è¯‘é™åˆ¶)

on:
  workflow_dispatch:
  push:

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_FIRMWARE: true
  TZ: Asia/Shanghai
  ALL_THREADS: 2
  DOCKER_IMAGE: ubuntu:22.04
  SOURCE_DIR: ./

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: 1. ç¡®è®¤æ–‡ä»¶å­˜åœ¨
        run: |
          ls -la $SOURCE_DIR/
          [ -f "$SOURCE_DIR/$CONFIG_FILE" ] || { echo "âŒ ç¼ºå°‘ $CONFIG_FILE"; exit 1; }
          [ -f "$SOURCE_DIR/$DIY_P1_SH" ] || { echo "âŒ ç¼ºå°‘ $DIY_P1_SH"; exit 1; }

      - name: 2. å‡†å¤‡ç¼–è¯‘ç›®å½•
        run: |
          sudo mkdir -p /mnt/openwrt-build
          sudo chown -R runner:runner /mnt/openwrt-build
          cp $SOURCE_DIR/$CONFIG_FILE $SOURCE_DIR/$DIY_P1_SH $SOURCE_DIR/$DIY_P2_SH /mnt/openwrt-build/
          chmod +x /mnt/openwrt-build/$DIY_P1_SH /mnt/openwrt-build/$DIY_P2_SH
          ls -la /mnt/openwrt-build/

      - name: 3. å¯åŠ¨ Docker å®¹å™¨
        run: |
          docker pull $DOCKER_IMAGE
          docker run -d --name openwrt-builder -v /mnt/openwrt-build:/build $DOCKER_IMAGE sleep infinity
          docker ps | grep -q "openwrt-builder" || { echo "âŒ å®¹å™¨å¯åŠ¨å¤±è´¥"; exit 1; }

      - name: 4. å®‰è£…ä¾èµ–
        run: |
          docker exec openwrt-builder bash -c "
            apt-get update -y && 
            DEBIAN_FRONTEND=noninteractive apt-get install -y tzdata build-essential flex bison g++ gawk gcc swig git libncurses5-dev libssl-dev zlib1g-dev python3 python3-pip rsync unzip wget file && 
            apt-get clean
          " || { echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥"; exit 1; }

      - name: 5. ç”Ÿæˆå¹¶æ‰§è¡Œç¼–è¯‘è„šæœ¬
        run: |
          cat > /mnt/openwrt-build/run-build.sh <<'EOS'
          set -e
          cd /build
          git clone --depth 1 "$REPO_URL" -b "$REPO_BRANCH" openwrt
          cd openwrt
          mv /build/$CONFIG_FILE .config
          sed -i 's/\r$//' .config /build/$DIY_P1_SH /build/$DIY_P2_SH
          /build/$DIY_P1_SH
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          /build/$DIY_P2_SH
          make defconfig
          make download -j"$ALL_THREADS"
          TARGET_COUNT=$(grep -cE '^CONFIG_TARGET_.+=y' .config)
          if [ "$TARGET_COUNT" -le 0 ]; then echo "âŒ .config æœªé€‰æ‹©ä»»ä½•ç›®æ ‡ï¼Œè¯·æ£€æŸ¥ .config"; exit 1; fi
          echo "ğŸ“Œ å·²é€‰æ‹©çš„ç›®æ ‡æ¡ç›®ï¼š"
          grep -E '^CONFIG_TARGET_.+=y' .config || echo "âš ï¸ æœªåˆ—å‡ºä»»ä½•ç›®æ ‡"
          FORCE_UNSAFE_CONFIGURE=1 make -j"$ALL_THREADS" || FORCE_UNSAFE_CONFIGURE=1 make -j1 V=s
          TARGET_DIR=$(find "$(pwd)/bin/targets" -mindepth 2 -maxdepth 2 -type d -print -quit 2>/dev/null)
          if [ -z "$TARGET_DIR" ]; then echo "âŒ æœªæ‰¾åˆ°ç¼–è¯‘äº§ç‰©ç›®å½•ï¼š$(pwd)/bin/targets/*/*"; exit 1; fi
          mkdir -p /build/firmware
          rsync -a --no-specials --no-devices --no-links --exclude=packages "$TARGET_DIR/" /build/firmware/
          chmod -R 755 /build/firmware
          EOS
          chmod +x /mnt/openwrt-build/run-build.sh
          docker exec \
            -e REPO_URL="$REPO_URL" \
            -e REPO_BRANCH="$REPO_BRANCH" \
            -e ALL_THREADS="$ALL_THREADS" \
            -e CONFIG_FILE="$CONFIG_FILE" \
            -e DIY_P1_SH="$DIY_P1_SH" \
            -e DIY_P2_SH="$DIY_P2_SH" \
            openwrt-builder bash /build/run-build.sh || { echo "âŒ ç¼–è¯‘å¤±è´¥"; exit 1; }

      - name: 5.5 å‡†å¤‡ Packit è¾“å…¥
        run: |
          mkdir -p "$GITHUB_WORKSPACE/firmware"
          if ls /mnt/openwrt-build/firmware/*rootfs*.tar.gz >/dev/null 2>&1; then \
            cp -a /mnt/openwrt-build/firmware/*rootfs*.tar.gz "$GITHUB_WORKSPACE/firmware/"; \
            echo "âœ… å·²å¤åˆ¶ rootfs åˆ°å·¥ä½œåŒºï¼š$GITHUB_WORKSPACE/firmware"; \
            ls -la "$GITHUB_WORKSPACE/firmware"; \
          else \
            echo "âŒ åœ¨ /mnt/openwrt-build/firmware æœªæ‰¾åˆ° rootfs tar.gz"; \
            ls -la /mnt/openwrt-build/firmware || true; \
            exit 1; \
          fi

      - name: 6. æ‰“åŒ… Armvirtï¼ˆä½¿ç”¨ä»“åº“å†…æ ¸ï¼‰
        uses: unifreq/openwrt_packit@master
        env:
          OPENWRT_ARMVIRT: firmware/*rootfs*.tar.gz
          PACKAGE_SOC: s905d_s905x3_beikeyun
          KERNEL_SOURCE: local
          KERNEL_DIR: ${{ github.workspace }}/flippy_kernel

      - name: 6.1 ä¿®å¤å›ºä»¶ç›®å½•æƒé™
        if: always()
        run: |
          sudo chown -R runner:runner /mnt/openwrt-build/firmware
          sudo chmod -R 775 /mnt/openwrt-build/firmware

      - name: 6. æ”¶é›† Packit äº§ç‰©
        run: |
          mkdir -p /mnt/openwrt-build/firmware/packit
          find "$GITHUB_WORKSPACE" -type f \( -name "*.img.gz" -o -name "*.img.xz" -o -name "*.zip" \) -print -exec cp {} /mnt/openwrt-build/firmware/packit/ \;
          echo "âœ… å·²æ”¶é›† Packit äº§ç‰©è‡³ /mnt/openwrt-build/firmware/packit"
          ls -la /mnt/openwrt-build/firmware/packit

      - name: 7. ä¸Šä¼ å›ºä»¶
        uses: actions/upload-artifact@main
        with:
          name: ImmortalWRT-Firmware
          path: /mnt/openwrt-build/firmware
          retention-days: 7

      - name: 8. æ¸…ç†ç¯å¢ƒ
        if: always()
        run: |
          docker stop openwrt-builder && docker rm openwrt-builder
          sudo rm -rf /mnt/openwrt-build