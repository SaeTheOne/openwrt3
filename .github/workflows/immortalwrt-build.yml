name: ImmortalWRT Build

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_COWTRANSFER: false
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: false
  TZ: Asia/Shanghai
  ALL_THREADS: 2

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
      - name: 检查磁盘初始空间
        run: |
          echo "=== 初始磁盘空间状态 ==="
          df -h
          echo "========================"
          df -h /mnt

      - name: 初始化环境（修复软件源+基础依赖）
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          # 关键修复1：先备份并恢复默认软件源（避免源配置异常）
          sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak
          echo "deb http://archive.ubuntu.com/ubuntu/ jammy main restricted universe multiverse" | sudo tee /etc/apt/sources.list
          echo "deb http://archive.ubuntu.com/ubuntu/ jammy-updates main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          echo "deb http://archive.ubuntu.com/ubuntu/ jammy-backports main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          echo "deb http://security.ubuntu.com/ubuntu/ jammy-security main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list

          # 关键修复2：多次更新源索引（确保完全加载）
          sudo apt-get -qq update || sudo apt-get -qq update || sudo apt-get -qq update

          # 清理冗余文件（此时源已更新，清理不影响）
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          sudo rm -rf /var/cache/apt/archives/*
          sudo rm -rf /usr/local/share/powershell /usr/share/swift /usr/lib/jvm /usr/lib/mono

          # 再次更新源（确保清理后源有效）
          sudo apt-get -qq update

          # 安装基础依赖（确保所有包可找到）
          sudo apt-get -qq install -y \
            build-essential flex bison g++ gawk \
            git libncurses5-dev libssl-dev \
            python3 python3-pip python3-setuptools python3-apt \
            rsync unzip zlib1g-dev file wget

          # 验证基础包是否安装成功
          if ! command -v gcc &> /dev/null; then
            echo "Error: gcc (from build-essential) not installed"
            exit 1
          fi

          # 清理缓存
          sudo apt-get -qq autoremove --purge
          sudo apt-get -qq clean
          
          # 显示清理后根分区空间
          echo "=== 清理后根分区空间 ==="
          df -h /

      - name: 准备大空间工作目录（/mnt）
        run: |
          sudo mkdir -p /mnt/workdir
          sudo chown -R runner:runner /mnt/workdir
          echo "=== /mnt/workdir 目录信息 ==="
          ls -ld /mnt/workdir
          echo "=== /mnt/workdir 所在分区空间 ==="
          df -hT /mnt/workdir

      - name: 克隆源码
        working-directory: /mnt/workdir
        run: |
          echo "=== 当前克隆目录 ==="
          echo $PWD
          df -hT $PWD
          git clone $REPO_URL -b $REPO_BRANCH openwrt
          cd openwrt && git pull
          ln -sf /mnt/workdir/openwrt $GITHUB_WORKSPACE/openwrt
          echo "=== 软链接验证 ==="
          ls -l $GITHUB_WORKSPACE/openwrt
          echo "=== 源码目录结构 ==="
          ls -la $GITHUB_WORKSPACE/openwrt

      - name: 加载自定义配置
        run: |
          [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
          [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
          chmod +x $DIY_P1_SH $DIY_P2_SH
          cd openwrt && ../$DIY_P1_SH

      - name: 更新 feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 应用自定义脚本
        run: |
          cd openwrt && ../$DIY_P2_SH

      - name: 下载软件包
        id: package
        run: |
          cd openwrt
          make defconfig
          make download -j$ALL_THREADS
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;
          echo "=== 下载包后 /mnt 空间 ==="
          df -h /mnt

      - name: 多线程编译
        run: |
          cd openwrt
          echo "=== 开始编译，当前线程数：$ALL_THREADS ==="
          make -j$ALL_THREADS || make -j1 || make -j1 V=s
          echo "=== 编译后 /mnt 空间 ==="
          df -h /mnt

      - name: 整理输出文件
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
        run: |
          cd openwrt/bin/targets/*/*
          rm -rf packages
          echo "FIRMWARE_DIR=$PWD" >> $GITHUB_ENV
          echo "::set-output name=status::success"
          echo "=== 输出文件列表 ==="
          ls -l

      - name: 上传固件到工件
        uses: actions/upload-artifact@main
        if: steps.organize.outputs.status == 'success' && !cancelled()
        with:
          name: ImmortalWRT-Firmware
          path: ${{ env.FIRMWARE_DIR }}

      - name: 上传固件到 Release
        uses: softprops/action-gh-release@master
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: ${{ env.FIRMWARE_DIR }}/*
          name: Build ${{ env.REPO_BRANCH }} @ ${{ github.sha }}
          body: |
            ## 自动构建固件
            - 源码分支：${{ env.REPO_BRANCH }}
            - 源码 Commit：${{ github.sha }}
            - 构建时间：${{ env.BUILD_DATE }}
          draft: false
          prerelease: false

      - name: 清理编译目录
        if: always()
        run: |
          cd openwrt && make clean
          echo "=== 清理后 /mnt 空间 ==="
          df -h /mnt
