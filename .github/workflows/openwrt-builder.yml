name: OpenWrt Builder

on:
  repository_dispatch:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"  # å¯é€‰ï¼šæ¯æ—¥UTC 2ç‚¹è‡ªåŠ¨æž„å»ºï¼ˆåŒ—äº¬æ—¶é—´10ç‚¹ï¼‰

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt/
  REPO_BRANCH: v24.10.4
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  SNAPSHOT_BASE_URL: https://downloads.openwrt.org/snapshots/targets/armsr/armv8
  SNAPSHOT_BASE_URL: https://downloads.openwrt.org/snapshots/targets/armsr/armv8

jobs:
  Build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Initialization environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          docker rmi $(docker images -q) 2>/dev/null || true
          [[ -n "${AGENT_TOOLSDIRECTORY}" ]] && rm -rf "${AGENT_TOOLSDIRECTORY}"
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E bash -c 'bash <(curl -s https://build-scripts.immortalwrt.org/init_build_environment.sh)'
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL https://is.gd/depends_ubuntu_2204)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "${TZ}"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: Clone source code
        working-directory: /workdir
        run: |
          df -hT $PWD
          git clone $REPO_URL -b $REPO_BRANCH openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

      - name: Load custom feeds
        run: |
          [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
          chmod +x $DIY_P1_SH
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P1_SH

      - name: Update feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Load custom configuration
        run: |
          [ -e files ] && mv files openwrt/files
          [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
          chmod +x $DIY_P2_SH
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P2_SH

      - name: åˆå¹¶æ ¹ç›®å½•é¢å¤–é…ç½®ï¼ˆadditional_configs.txtï¼‰
        run: |
          # æ£€æŸ¥é¡¹ç›®æ ¹ç›®å½•æ˜¯å¦å­˜åœ¨ additional_configs.txt
          if [ -f "$GITHUB_WORKSPACE/additional_configs.txt" ]; then
            echo "âœ… æ‰¾åˆ°é¢å¤–é…ç½®æ–‡ä»¶ï¼Œå¼€å§‹åˆå¹¶åˆ° OpenWrt .config..."
            # å¤åˆ¶æ–‡ä»¶åˆ° OpenWrt æºç ç›®å½•
            cp $GITHUB_WORKSPACE/additional_configs.txt openwrt/
            cd openwrt
            # è¿½åŠ é…ç½®åˆ° .configï¼ˆè¦†ç›–é‡å¤é¡¹ï¼Œä¿ç•™æœ€åŽç”Ÿæ•ˆï¼‰
            cat additional_configs.txt >> .config
            # è‡ªåŠ¨ä¿®å¤é…ç½®ä¾èµ–å†²çª
            make defconfig
            echo "âœ… é…ç½®åˆå¹¶å®Œæˆï¼"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° additional_configs.txtï¼Œè·³è¿‡åˆå¹¶æ­¥éª¤"
          fi

      - name: Download package dependencies
        id: package
        run: |
          cd openwrt
          make download -j$(nproc)
          # æ¸…ç†æ— æ•ˆä¸‹è½½æ–‡ä»¶ï¼ˆå°äºŽ1KBçš„æ–‡ä»¶ï¼‰
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: Compile firmware
        id: compile
        run: |
          cd openwrt
          echo "ðŸ“¦ å¼€å§‹ç¼–è¯‘ï¼Œä½¿ç”¨ $(nproc) çº¿ç¨‹"
          make -j$(nproc) || make -j1 || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          # æå–ç›®æ ‡è®¾å¤‡åž‹å·
          DEVICE=$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/')
          echo "device=${DEVICE}" >> $GITHUB_OUTPUT
          echo "firmware_dir=openwrt/bin/targets/$(grep '^CONFIG_TARGET_BOARD' .config | sed -r 's/.*="(.*)"/\1')/$(grep '^CONFIG_TARGET_SUBTARGET' .config | sed -r 's/.*="(.*)"/\1')" >> $GITHUB_OUTPUT

      - name: Organize firmware files
        id: organize
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true'
        run: |
          mkdir -p $GITHUB_WORKSPACE/firmware
          cp -r ${{ steps.compile.outputs.firmware_dir }}/* $GITHUB_WORKSPACE/firmware/
          # æ¸…ç†å†—ä½™æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
          rm -rf $GITHUB_WORKSPACE/firmware/packages
          echo "âœ… å›ºä»¶æ–‡ä»¶æ•´ç†å®Œæˆ"
          echo "firmware_path=$GITHUB_WORKSPACE/firmware" >> $GITHUB_OUTPUT

      - name: Upload firmware to Artifacts
        if: steps.organize.outputs.firmware_path != ''
        uses: actions/upload-artifact@main
        with:
          name: OpenWrt-Firmware-${{ steps.compile.outputs.device }}
          path: ${{ steps.organize.outputs.firmware_path }}

      - name: Upload firmware to Release
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
        uses: softprops/action-gh-release@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.sha }}
          release_name: OpenWrt Firmware (${{ steps.compile.outputs.device }})
          files: ${{ steps.organize.outputs.firmware_path }}/*
          body: |
            ## æž„å»ºä¿¡æ¯
            - æºç åˆ†æ”¯ï¼š${{ env.REPO_BRANCH }}
            - ç›®æ ‡è®¾å¤‡ï¼š${{ steps.compile.outputs.device }}
            - æž„å»ºæ—¶é—´ï¼š${{ env.TZ }} $(date +"%Y-%m-%d %H:%M:%S")
            - æäº¤å“ˆå¸Œï¼š${{ github.sha }}

      - name: Remove old Releases
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        uses: dev-drprasad/delete-older-releases@master
        with:
          keep_latest: 3  # ä¿ç•™æœ€æ–°3ä¸ªå‘å¸ƒ
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  Snapshot:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Download OpenWrt snapshot rootfs (armsr/armv8)
        id: download
        run: |
          set -e
          BASE_URL="${SNAPSHOT_BASE_URL}"
          FILE1="openwrt-armsr-armv8-rootfs.tar.gz"
          FILE2="openwrt-armsr-armv8-generic-rootfs.tar.gz"
          FILE3="rootfs.tar.gz"
          mkdir -p "$GITHUB_WORKSPACE/snapshot"
          cd "$GITHUB_WORKSPACE/snapshot"
          for F in "$FILE1" "$FILE2" "$FILE3"; do
            URL="$BASE_URL/$F"
            echo "å°è¯•ä¸‹è½½: $URL"
            if curl -fsSL "$URL" -o "$F"; then
              DOWNLOADED="$F"; break; fi
          done
          if [ -z "$DOWNLOADED" ]; then
            echo "âŒ æœªèƒ½ä»Ž $BASE_URL ä¸‹è½½ rootfs.tar.gz"
            exit 1
          fi
          TARGET="openwrt-armsr-armv8-generic-rootfs.tar.gz"
          mv "$DOWNLOADED" "$TARGET"
          ls -lh "$TARGET"
          echo "rootfs_path=$GITHUB_WORKSPACE/snapshot/$TARGET" >> $GITHUB_OUTPUT

      - name: Upload rootfs artifact for packing
        uses: actions/upload-artifact@main
        with:
          name: openwrt-armsr-armv8-generic-rootfs.tar.gz
          path: ${{ steps.download.outputs.rootfs_path }}

  SnapshotImageBuilder:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id
    env:
      BASE_URL: ${{ env.SNAPSHOT_BASE_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Install ImageBuilder dependencies
        run: |
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install build-essential zstd ca-certificates wget rsync python3 libncurses5-dev

      - name: Download OpenWrt ImageBuilder (armsr/armv8)
        run: |
          set -e
          URL="${BASE_URL}/openwrt-imagebuilder-armsr-armv8.Linux-x86_64.tar.zst"
          echo "ä¸‹è½½: $URL"
          wget -O imagebuilder.tar.zst "$URL"
          ls -lh imagebuilder.tar.zst

      - name: Extract ImageBuilder
        run: |
          set -e
          tar -I zstd -xf imagebuilder.tar.zst
          IMGBUILDER_DIR=$(find . -maxdepth 1 -type d -name 'openwrt-imagebuilder-*' | head -n1)
          echo "IMGBUILDER_DIR=$IMGBUILDER_DIR" >> $GITHUB_ENV
          test -d "$IMGBUILDER_DIR" && ls -la "$IMGBUILDER_DIR"

      - name: Build snapshot rootfs via ImageBuilder
        run: |
          set -e
          cd "$IMGBUILDER_DIR"
          make info || true
          if [ -d "$GITHUB_WORKSPACE/files" ]; then
            cp -r "$GITHUB_WORKSPACE/files" ./files
          fi
          make image PROFILE=generic PACKAGES=""
          ROOTFS=$(find bin/targets/*/* -name "*-generic-rootfs.tar.gz" | head -n1)
          if [ -z "$ROOTFS" ]; then
            echo "âŒ æœªæ‰¾åˆ° *-generic-rootfs.tar.gz"
            ls -l bin/targets/*/* || true
            exit 1
          fi
          echo "rootfs_path=$PWD/$ROOTFS" >> $GITHUB_OUTPUT
          echo "rootfs_basename=$(basename "$ROOTFS")" >> $GITHUB_OUTPUT

      - name: Upload rootfs artifact for packing
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.Build_snapshot_rootfs_via_ImageBuilder.outputs.rootfs_basename }}
          path: ${{ steps.Build_snapshot_rootfs_via_ImageBuilder.outputs.rootfs_path }}

  PackSnapshotIB:
    needs: SnapshotImageBuilder
    uses: ./.github/workflows/pack-image.yml
    secrets: inherit

  ReleaseSnapshotIB:
    needs: [SnapshotImageBuilder, PackSnapshotIB]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Download packed image
        uses: actions/download-artifact@v4
        with:
          pattern: "*-packed-image"
          merge-multiple: true

      - name: Download original rootfs
        uses: actions/download-artifact@v4
        with:
          pattern: "*.tar.gz"
          merge-multiple: true

      - name: Generate release tag
        id: tag
        run: |
          echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          files: |
            */*-packed-image/*.img
            */*.tar.gz
          body: |
            Built from OpenWrt snapshot (armsr/armv8) via ImageBuilder
            Source: ${{ env.SNAPSHOT_BASE_URL }}
            Date: $(date +"%Y-%m-%d %H:%M:%S")

  PackSnapshot:
    needs: Snapshot
    uses: ./.github/workflows/pack-image.yml
    secrets: inherit

  ReleaseSnapshot:
    needs: [Snapshot, PackSnapshot]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Download packed image
        uses: actions/download-artifact@v4
        with:
          pattern: "*-packed-image"
          merge-multiple: true

      - name: Download original rootfs
        uses: actions/download-artifact@v4
        with:
          pattern: "*.tar.gz"
          merge-multiple: true

      - name: Generate release tag
        id: tag
        run: |
          echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          files: |
            */*-packed-image/*.img
            */*.tar.gz
          body: |
            Built from OpenWrt snapshot (armsr/armv8)
            Source: ${{ env.SNAPSHOT_BASE_URL }}
            Date: $(date +"%Y-%m-%d %H:%M:%S")
name: OpenWrt Snapshot Source Builder

on:
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init env
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: Clone source
        working-directory: /workdir
        run: |
          git clone https://github.com/openwrt/openwrt/ -b master openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

      - name: Load custom feeds
        run: |
          if [ -e feeds.conf.default ]; then mv feeds.conf.default openwrt/feeds.conf.default; fi
          chmod +x diy-part1.sh || true
          cd openwrt
          $GITHUB_WORKSPACE/diy-part1.sh || true

      - name: Update feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Load configuration
        run: |
          if [ -e files ]; then mv files openwrt/files; fi
          if [ -e .config ]; then mv .config openwrt/.config; fi
          chmod +x diy-part2.sh || true
          cd openwrt
          $GITHUB_WORKSPACE/diy-part2.sh || true
          if [ -f "$GITHUB_WORKSPACE/additional_configs.txt" ]; then
            cat "$GITHUB_WORKSPACE/additional_configs.txt" >> .config
          fi
          make defconfig

      - name: Download
        run: |
          cd openwrt
          make download -j$(nproc)
          find dl -size -1024c -exec rm -f {} \;

      - name: Compile
        id: compile
        run: |
          cd openwrt
          make -j$(nproc) || make -j1 || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          BOARD=$(grep '^CONFIG_TARGET_BOARD' .config | sed -r 's/.*="(.*)"/\1/')
          SUB=$(grep '^CONFIG_TARGET_SUBTARGET' .config | sed -r 's/.*="(.*)"/\1/')
          echo "firmware_dir=openwrt/bin/targets/$BOARD/$SUB" >> $GITHUB_OUTPUT

      - name: Find rootfs
        id: find_rootfs
        if: steps.compile.outputs.status == 'success'
        run: |
          ROOTFS=$(find ${{ steps.compile.outputs.firmware_dir }} -name "*-generic-rootfs.tar.gz" | head -n1)
          if [ -z "$ROOTFS" ]; then
            exit 1
          fi
          echo "rootfs_path=$ROOTFS" >> $GITHUB_OUTPUT
          echo "rootfs_basename=$(basename "$ROOTFS")" >> $GITHUB_OUTPUT

      - name: Upload rootfs
        uses: actions/upload-artifact@v4
        if: steps.find_rootfs.outputs.rootfs_path != ''
        with:
          name: ${{ steps.find_rootfs.outputs.rootfs_basename }}
          path: ${{ steps.find_rootfs.outputs.rootfs_path }}

  pack:
    needs: build
    uses: ./.github/workflows/pack-image.yml
    secrets: inherit

  release:
    needs: [build, pack]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download packed image
        uses: actions/download-artifact@v4
        with:
          pattern: "*-packed-image"
          merge-multiple: true

      - name: Download original rootfs
        uses: actions/download-artifact@v4
        with:
          pattern: "*.tar.gz"
          merge-multiple: true

      - name: Tag
        id: tag
        run: |
          echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT

      - name: Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          files: |
            */*-packed-image/*.img
            */*.tar.gz
