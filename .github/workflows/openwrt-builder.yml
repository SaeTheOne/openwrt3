name: OpenWRT Builder

on:
  push:
    branches: [main]
    paths:
      - '.github/workflows/openwrt-builder.yml'
      - 'configs/**'
      - 'patches/**'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      config:
        description: 'Config file name (without .config) - ç•™ç©ºæˆ–ä½¿ç”¨éå­˜åœ¨å€¼æ—¶å°†è‡ªåŠ¨ä¸‹è½½é…ç½®'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      OPENWRT_SRC_URL: https://github.com/immortalwrt/immortalwrt.git
      OPENWRT_BRANCH: openwrt-23.05
      FEEDS_CONF: feeds.conf.default
      CONFIG_FILE: ${{ github.event.inputs.config || 'default_auto_download' }}
      OUTPUT_DIR: bin/targets/*/*

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Initialization environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          # ğŸ”§ ä¿®å¤ï¼šå®‰è£…å®Œæ•´ä¾èµ–ï¼ˆå« Python3 ç›¸å…³ï¼Œè§£å†³ python3-distutils ä¾èµ–è­¦å‘Šï¼‰
          sudo apt update -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib \
            gettext git libncurses5-dev libssl-dev python3 python3-pip python3-setuptools \
            rsync subversion unzip wget zlib1g-dev file jq curl

      - name: Clone OpenWRT source
        run: |
          git clone --depth 1 -b $OPENWRT_BRANCH $OPENWRT_SRC_URL openwrt
          cd openwrt
          # ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨æºç è‡ªå¸¦é…ç½®ï¼Œæ›´æ–°å¹¶å®‰è£… feedsï¼ˆè‡ªåŠ¨å¤„ç†éƒ¨åˆ†ä¾èµ–ä¿®å¤ï¼‰
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Apply patches
        run: |
          cd openwrt
          if [ -d ../patches ]; then
            for patch in $(find ../patches -name "*.patch" | sort); do
              echo "Applying patch: $patch"
              patch -p1 < $patch || exit 1
            done
          fi

      - name: Load config
        run: |
          cd openwrt
          # é»˜è®¤ä»OpenWrté•œåƒç«™ä¸‹è½½é…ç½®æ–‡ä»¶
          echo "ğŸ“¥ é»˜è®¤ä»OpenWrté•œåƒç«™ä¸‹è½½é…ç½®æ–‡ä»¶"
          # æ ¹æ®åˆ†æ”¯ä¿¡æ¯æ„é€ ä¸‹è½½é“¾æ¥ï¼ˆARMæ¶æ„ï¼‰
          if [[ "$OPENWRT_BRANCH" == openwrt-* ]]; then
              # æå–ç‰ˆæœ¬å·ï¼ˆå»æ‰openwrt-å‰ç¼€ï¼‰
              VERSION=${OPENWRT_BRANCH#openwrt-}
              CONFIG_URL="https://downloads.openwrt.org/releases/$VERSION/targets/armsr/armv8/config.buildinfo"
              echo "ğŸ”— æ­£åœ¨ä»ç‰ˆæœ¬å‘å¸ƒåœ°å€ä¸‹è½½ARMæ¶æ„é…ç½®: $CONFIG_URL"
            else
              # å¿«ç…§ç‰ˆæœ¬
              CONFIG_URL="https://downloads.openwrt.org/snapshots/targets/armsr/armv8/config.buildinfo"
              echo "ğŸ”— æ­£åœ¨ä»å¿«ç…§åœ°å€ä¸‹è½½ARMæ¶æ„é…ç½®: $CONFIG_URL"
          fi
          
          # ä¸‹è½½config.buildinfo
          wget -O .config "$CONFIG_URL" || {
            echo "âŒ ä¸‹è½½é…ç½®æ–‡ä»¶å¤±è´¥ï¼Œå°†å°è¯•ä½¿ç”¨æœ¬åœ°é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰"
            # å¦‚æœä¸‹è½½å¤±è´¥ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æœ¬åœ°é…ç½®æ–‡ä»¶ä½œä¸ºå¤‡ä»½
            if [ -f ../configs/$CONFIG_FILE.config ]; then
              echo "âœ… æ‰¾åˆ° configs/$CONFIG_FILE.config æ–‡ä»¶ï¼Œä½œä¸ºå¤‡ç”¨ä½¿ç”¨"
              cp ../configs/$CONFIG_FILE.config .config
            else
              echo "âŒ æœ¬åœ°é…ç½®æ–‡ä»¶ä¹Ÿä¸å­˜åœ¨ï¼Œæ„å»ºå¤±è´¥ï¼"
              exit 1
            fi
          }
          # ğŸ”§ ä¿®å¤ï¼šè‡ªåŠ¨å®‰è£…ç¼ºå¤±çš„ä¾èµ–åŒ…ï¼ˆå…³é”®ï¼è§£å†³ä¾èµ–è­¦å‘Šï¼‰
          make defconfig
          # ğŸ”§ ä¼˜åŒ–ï¼šåˆ é™¤å†—ä½™çš„ python3-distutils ä¾èµ–å£°æ˜ï¼ˆæ‰¹é‡å¤„ç†ï¼‰
          find package/feeds -name "Makefile" -type f | xargs sed -i '/DEPENDS.*python3-distutils/d'

      - name: Download packages
        run: |
          cd openwrt
          make download -j$(nproc)
          # ğŸ”§ ä¼˜åŒ–ï¼šç¼“å­˜ä¸‹è½½çš„åŒ…ï¼ŒåŠ é€Ÿä¸‹æ¬¡ç¼–è¯‘
          find dl -type f -exec sha256sum {} \; > ../dl-cache.sha256

      - name: Build firmware
        run: |
          cd openwrt
          # ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨å¤šçº¿ç¨‹ç¼–è¯‘ï¼ˆæ ¹æ® CPU æ ¸å¿ƒæ•°è°ƒæ•´ï¼‰
          make -j$(nproc) V=s
          # ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥ç¼–è¯‘ç»“æœï¼Œç¡®ä¿å›ºä»¶ç”Ÿæˆ
          if [ ! -d "$OUTPUT_DIR" ]; then
            echo "Firmware build failed! No output directory found."
            exit 1
          fi

      - name: Organize output files
        run: |
          cd openwrt
          mkdir -p ../output
          # ğŸ”§ ä¼˜åŒ–ï¼šå¤åˆ¶å›ºä»¶å’Œæ ¡éªŒæ–‡ä»¶ï¼Œé‡å‘½åä¾¿äºè¯†åˆ«
          cp -r $OUTPUT_DIR/* ../output/
          cd ../output
          for file in $(find . -name "*.bin" -o -name "*.img"); do
            mv $file $(basename $file .bin)-$CONFIG_FILE.bin
          done
          # ç”Ÿæˆæ ¡éªŒå’Œæ–‡ä»¶
          sha256sum * > firmware-sha256.txt

      - name: Compile firmware
        id: compile
        run: |
          cd openwrt
          echo -e "$(nproc) thread compile"
          make -j$(nproc) || make -j1 || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          # ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œé¿å…æ ¼å¼é”™è¯¯
          # ä¸ºDEVICE_NAMEæä¾›é»˜è®¤å€¼ï¼Œç¡®ä¿ä¸ä¼šå‡ºç°ç©ºå€¼é—®é¢˜
          echo "DEVICE_NAME=_armvirt_64" >> "$GITHUB_ENV"
          
          if grep -q '^CONFIG_TARGET.*DEVICE.*=y' .config; then
              DEV_NAME=$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' | tr -d '\r\n')
              if [ -n "$DEV_NAME" ]; then
                  echo "DEVICE_NAME=_${DEV_NAME}" >> "$GITHUB_ENV"
              fi
          fi
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> "$GITHUB_ENV"

      - name: Check space usage
        if: ${{ !cancelled() }}
        run: df -hT

      - name: Upload bin directory
        uses: actions/upload-artifact@v4
        if: ${{ steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true' }}
        with:
          name: OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: openwrt/bin

      - name: Organize firmware files
        id: organize
        if: ${{ env.UPLOAD_FIRMWARE == 'true' && !cancelled() }}
        run: |
          cd openwrt/bin/targets/*/*
          ROOTFS=$(find "$PWD" -maxdepth 1 -name "*-generic-rootfs.tar.gz" | head -n1)
          if [ -z "$ROOTFS" ]; then
            ROOTFS=$(find "$PWD" -maxdepth 1 -name "*-rootfs.tar.gz" | head -n1)
          fi
          if [ -z "$ROOTFS" ]; then
            echo "âŒ No rootfs tarball found!"; ls -la; exit 1
          fi
          ls -lh "$ROOTFS"
          BASENAME=$(basename "$ROOTFS")
          # ä½¿ç”¨æ ‡å‡†æ ¼å¼è®¾ç½®è¾“å‡ºå˜é‡ï¼Œé¿å…fileå‘½ä»¤é”™è¯¯
          echo "rootfs_path=${ROOTFS}" >> "${GITHUB_OUTPUT}"
          echo "rootfs_basename=${BASENAME}" >> "${GITHUB_OUTPUT}"
          echo "firmware_path=${PWD}" >> "${GITHUB_OUTPUT}"
          echo "âœ… Found rootfs: $ROOTFS"

      - name: Upload rootfs artifact for packing
        uses: actions/upload-artifact@v4
        if: ${{ steps.organize.outputs.rootfs_path && !cancelled() }}
        with:
          name: ${{ steps.organize.outputs.rootfs_basename }}
          path: ${{ steps.organize.outputs.rootfs_path }}

      - name: Clean up after build
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†æ„å»ºç¯å¢ƒ..."
          sudo rm -rf /workdir/*
          docker system prune -af 2>/dev/null || true
          echo "âœ… æ„å»ºç¯å¢ƒæ¸…ç†å®Œæˆï¼Œè™šæ‹Ÿæœºå°†è‡ªåŠ¨å…³é—­"

  pack:
    needs: build
    uses: ./.github/workflows/pack-image.yml
    with:
      rootfs_path: ${{ needs.build.outputs.rootfs_path }}
      kernel_base_url: https://raw.githubusercontent.com/SaeTheOne/openwrt3/main/flippy_kernel
