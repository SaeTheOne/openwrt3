name: ğŸ”§ Pack with Your Kernel (Exact Steps)

on:
  workflow_dispatch:

jobs:
  pack:
    runs-on: ubuntu-22.04
    steps:
      - name: Download rootfs
        run: |
          URL="https://github.com/SaeTheOne/openwrt3/releases/download/1.0/immortalwrt-24.10.4-armsr-armv8-generic-rootfs.tar.gz"
          wget -O downloaded.tar.gz "$URL"
          mv downloaded.tar.gz openwrt24.10.4-armsr-armv8-generic-rootfs.tar.gz
          echo "ROOTFS_FILE=openwrt24.10.4-armsr-armv8-generic-rootfs.tar.gz" >> $GITHUB_ENV

      - name: Checkout openwrt_packit
        uses: actions/checkout@v4
        with:
          repository: unifreq/openwrt_packit
          path: openwrt_packit

      - name: Download kernel files (exact file names)
        run: |
          sudo mkdir -p /opt/kernel
          cd /tmp
          echo "ğŸ“¥ Downloading your kernel files (exact names) from flippy_kernel..."

          # ä½¿ç”¨æ‚¨æä¾›çš„æ–‡ä»¶åï¼ˆä¸æ‚¨çš„æ–‡ä»¶å®Œå…¨ä¸€è‡´ï¼‰
          wget https://raw.githubusercontent.com/SaeTheOne/openwrt3/main/flippy_kernel/boot-6.12.46-flippy-93+.tar.gz
          wget https://raw.githubusercontent.com/SaeTheOne/openwrt3/main/flippy_kernel/dtb-allwinner-6.12.46-flippy-93+.tar.gz
          wget https://raw.githubusercontent.com/SaeTheOne/openwrt3/main/flippy_kernel/dtb-amlogic-6.12.46-flippy-93+.tar.gz
          wget https://raw.githubusercontent.com/SaeTheOne/openwrt3/main/flippy_kernel/dtb-rockchip-6.12.46-flippy-93+.tar.gz
          wget https://raw.githubusercontent.com/SaeTheOne/openwrt3/main/flippy_kernel/header-6.12.46-flippy-93+.tar.gz
          wget https://raw.githubusercontent.com/SaeTheOne/openwrt3/main/flippy_kernel/modules-6.12.46-flippy-93+.tar.gz

          sudo cp boot-6.12.46-flippy-93+.tar.gz /opt/kernel/
          sudo cp dtb-allwinner-6.12.46-flippy-93+.tar.gz /opt/kernel/
          sudo cp dtb-amlogic-6.12.46-flippy-93+.tar.gz /opt/kernel/
          sudo cp dtb-rockchip-6.12.46-flippy-93+.tar.gz /opt/kernel/
          sudo cp header-6.12.46-flippy-93+.tar.gz /opt/kernel/
          sudo cp modules-6.12.46-flippy-93+.tar.gz /opt/kernel/

      - name: Copy your whoami file
        run: |
          # ç›´æ¥ä½¿ç”¨æ‚¨æä¾›çš„ whoami æ–‡ä»¶
          wget https://raw.githubusercontent.com/SaeTheOne/openwrt3/main/flippy_kernel/whoami -O /tmp/whoami
          sudo mkdir -p /opt/openwrt_packit
          sudo cp /tmp/whoami /opt/openwrt_packit/whoami

      - name: Copy rootfs into packit dir
        run: cp "${{ env.ROOTFS_FILE }}" openwrt_packit/

      - name: Run packing script
        working-directory: openwrt_packit
        run: sudo ./mk_s905d_n1.sh _test

      - name: Upload packed image
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-packed-image
          path: openwrt_packit/output/*.img
          if-no-files-found: error
