name: ğŸ”§ Pack with Your Kernel (Exact 7 Files)

on:
  workflow_dispatch:

jobs:
  pack:
    runs-on: ubuntu-22.04
    steps:
      - name: Download rootfs
        run: |
          URL="https://github.com/SaeTheOne/openwrt3/releases/download/1.0/immortalwrt-24.10.4-armsr-armv8-generic-rootfs.tar.gz"
          wget -O downloaded.tar.gz "$URL"
          mv downloaded.tar.gz openwrt24.10.4-armsr-armv8-generic-rootfs.tar.gz
          echo "ROOTFS_FILE=openwrt24.10.4-armsr-armv8-generic-rootfs.tar.gz" >> $GITHUB_ENV

      - name: Checkout openwrt_packit
        uses: actions/checkout@v4
        with:
          repository: unifreq/openwrt_packit
          path: openwrt_packit

      - name: Download and extract your 7 kernel files
        run: |
          sudo mkdir -p /opt/kernel
          cd /tmp
          echo "ğŸ“¥ Downloading your 7 kernel files from flippy_kernel directory..."

          # ä¸¥æ ¼æŒ‰æ‚¨æä¾›çš„æ–‡ä»¶åä¸‹è½½
          sudo wget https://raw.githubusercontent.com/SaeTheOne/openwrt3/main/flippy_kernel/boot-6.12.46-flippy-93+.tar.gz
          sudo wget https://raw.githubusercontent.com/SaeTheOne/openwrt3/main/flippy_kernel/dtb-allwinner-6.12.46-flippy-93+.tar.gz
          sudo wget https://raw.githubusercontent.com/SaeTheOne/openwrt3/main/flippy_kernel/dtb-amlogic-6.12.46-flippy-93+.tar.gz
          sudo wget https://raw.githubusercontent.com/SaeTheOne/openwrt3/main/flippy_kernel/dtb-rockchip-6.12.46-flippy-93+.tar.gz
          sudo wget https://raw.githubusercontent.com/SaeTheOne/openwrt3/main/flippy_kernel/header-6.12.46-flippy-93+.tar.gz
          sudo wget https://raw.githubusercontent.com/SaeTheOne/openwrt3/main/flippy_kernel/modules-6.12.46-flippy-93+.tar.gz

          # è§£å‹æ‰€æœ‰ tar.gz æ–‡ä»¶åˆ° /opt/kernel/
          sudo tar -xzf boot-6.12.46-flippy-93+.tar.gz -C /opt/kernel/
          sudo tar -xzf dtb-allwinner-6.12.46-flippy-93+.tar.gz -C /opt/kernel/
          sudo tar -xzf dtb-amlogic-6.12.46-flippy-93+.tar.gz -C /opt/kernel/
          sudo tar -xzf dtb-rockchip-6.12.46-flippy-93+.tar.gz -C /opt/kernel/
          sudo tar -xzf header-6.12.46-flippy-93+.tar.gz -C /opt/kernel/
          sudo tar -xzf modules-6.12.46-flippy-93+.tar.gz -C /opt/kernel/

          echo "ğŸ“ Verified files in /opt/kernel/:"
          ls -l /opt/kernel/

      - name: Copy your whoami file
        run: |
          wget https://raw.githubusercontent.com/SaeTheOne/openwrt3/main/flippy_kernel/whoami -O openwrt_packit/whoami

      - name: Copy rootfs into packit dir
        run: cp "${{ env.ROOTFS_FILE }}" openwrt_packit/

      - name: Run packing script
        working-directory: openwrt_packit
        run: sudo ./mk_s905d_n1.sh _test

      - name: Upload packed image
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-packed-image
          path: openwrt_packit/output/*.img
          if-no-files-found: error
