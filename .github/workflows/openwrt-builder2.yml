name: OpenWrt Builder

on:
  repository_dispatch:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"  # å¯é€‰ï¼šæ¯æ—¥UTC 2ç‚¹è‡ªåŠ¨æ„å»ºï¼ˆåŒ—äº¬æ—¶é—´10ç‚¹ï¼‰

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt/
  REPO_BRANCH: v24.10.4
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  Build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Initialization environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          docker rmi $(docker images -q) 2>/dev/null || true
          [[ -n "${AGENT_TOOLSDIRECTORY}" ]] && rm -rf "${AGENT_TOOLSDIRECTORY}"
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL https://is.gd/depends_ubuntu_2204)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "${TZ}"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: Clone source code
        working-directory: /workdir
        run: |
          df -hT $PWD
          git clone $REPO_URL -b $REPO_BRANCH openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

      - name: Load custom feeds
        run: |
          [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
          chmod +x $DIY_P1_SH
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P1_SH

      - name: Update feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Load custom configuration
        run: |
          [ -e files ] && mv files openwrt/files
          [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
          chmod +x $DIY_P2_SH
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P2_SH

      - name: åˆå¹¶æ ¹ç›®å½•é¢å¤–é…ç½®ï¼ˆadditional_configs.txtï¼‰
        run: |
          # æ£€æŸ¥é¡¹ç›®æ ¹ç›®å½•æ˜¯å¦å­˜åœ¨ additional_configs.txt
          if [ -f "$GITHUB_WORKSPACE/additional_configs.txt" ]; then
            echo "âœ… æ‰¾åˆ°é¢å¤–é…ç½®æ–‡ä»¶ï¼Œå¼€å§‹åˆå¹¶åˆ° OpenWrt .config..."
            # å¤åˆ¶æ–‡ä»¶åˆ° OpenWrt æºç ç›®å½•
            cp $GITHUB_WORKSPACE/additional_configs.txt openwrt/
            cd openwrt
            # è¿½åŠ é…ç½®åˆ° .configï¼ˆè¦†ç›–é‡å¤é¡¹ï¼Œä¿ç•™æœ€åç”Ÿæ•ˆï¼‰
            cat additional_configs.txt >> .config
            # è‡ªåŠ¨ä¿®å¤é…ç½®ä¾èµ–å†²çª
            make defconfig
            echo "âœ… é…ç½®åˆå¹¶å®Œæˆï¼"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° additional_configs.txtï¼Œè·³è¿‡åˆå¹¶æ­¥éª¤"
          fi

      - name: Download package dependencies
        id: package
        run: |
          cd openwrt
          make download -j$(nproc)
          # æ¸…ç†æ— æ•ˆä¸‹è½½æ–‡ä»¶ï¼ˆå°äº1KBçš„æ–‡ä»¶ï¼‰
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: Compile firmware
        id: compile
        run: |
          cd openwrt
          echo "ğŸ“¦ å¼€å§‹ç¼–è¯‘ï¼Œä½¿ç”¨ $(nproc) çº¿ç¨‹"
          make -j$(nproc) || make -j1 || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          # æå–ç›®æ ‡è®¾å¤‡å‹å·
          DEVICE=$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/')
          echo "device=${DEVICE}" >> $GITHUB_OUTPUT
          echo "firmware_dir=openwrt/bin/targets/$(grep '^CONFIG_TARGET_BOARD' .config | sed -r 's/.*="(.*)"/\1')/$(grep '^CONFIG_TARGET_SUBTARGET' .config | sed -r 's/.*="(.*)"/\1')" >> $GITHUB_OUTPUT

      - name: Organize firmware files
        id: organize
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true'
        run: |
          mkdir -p $GITHUB_WORKSPACE/firmware
          cp -r ${{ steps.compile.outputs.firmware_dir }}/* $GITHUB_WORKSPACE/firmware/
          # æ¸…ç†å†—ä½™æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
          rm -rf $GITHUB_WORKSPACE/firmware/packages
          echo "âœ… å›ºä»¶æ–‡ä»¶æ•´ç†å®Œæˆ"
          echo "firmware_path=$GITHUB_WORKSPACE/firmware" >> $GITHUB_OUTPUT

      - name: Upload firmware to Artifacts
        if: steps.organize.outputs.firmware_path != ''
        uses: actions/upload-artifact@main
        with:
          name: OpenWrt-Firmware-${{ steps.compile.outputs.device }}
          path: ${{ steps.organize.outputs.firmware_path }}

      - name: Upload firmware to Release
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
        uses: softprops/action-gh-release@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.sha }}
          release_name: OpenWrt Firmware (${{ steps.compile.outputs.device }})
          files: ${{ steps.organize.outputs.firmware_path }}/*
          body: |
            ## æ„å»ºä¿¡æ¯
            - æºç åˆ†æ”¯ï¼š${{ env.REPO_BRANCH }}
            - ç›®æ ‡è®¾å¤‡ï¼š${{ steps.compile.outputs.device }}
            - æ„å»ºæ—¶é—´ï¼š${{ env.TZ }} $(date +"%Y-%m-%d %H:%M:%S")
            - æäº¤å“ˆå¸Œï¼š${{ github.sha }}

      - name: Remove old Releases
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        uses: dev-drprasad/delete-older-releases@master
        with:
          keep_latest: 3  # ä¿ç•™æœ€æ–°3ä¸ªå‘å¸ƒ
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
